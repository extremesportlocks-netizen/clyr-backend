<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLYR Health — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #06080f;
    --surface: #0d1117;
    --surface-2: #151b26;
    --surface-3: #1c2333;
    --border: #21283b;
    --border-glow: #2d3652;
    --cyan: #00d4ff;
    --cyan-dim: rgba(0,212,255,0.12);
    --green: #00f5a0;
    --green-dim: rgba(0,245,160,0.12);
    --purple: #a78bfa;
    --purple-dim: rgba(167,139,250,0.12);
    --red: #ff4757;
    --red-dim: rgba(255,71,87,0.12);
    --yellow: #ffc107;
    --yellow-dim: rgba(255,193,7,0.12);
    --text: #e6edf3;
    --text-dim: #7d8590;
    --text-bright: #ffffff;
    --font: 'Inter', -apple-system, sans-serif;
    --glow: 0 0 20px rgba(0,212,255,0.15);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  #loginView {
    display: flex; align-items: center; justify-content: center; min-height: 100vh;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,212,255,0.08) 0%, transparent 60%), var(--bg);
  }
  .login-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 48px; width: 420px; text-align: center;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5), var(--glow);
  }
  .login-logo { font-size: 36px; font-weight: 900; letter-spacing: -1px; margin-bottom: 4px; }
  .login-logo .c { color: var(--cyan); }
  .login-sub { color: var(--text-dim); font-size: 14px; margin-bottom: 32px; font-weight: 500; }
  .login-box input {
    width: 100%; padding: 14px 18px; margin-bottom: 12px;
    background: var(--surface-2); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); font-family: var(--font); font-size: 14px; outline: none; transition: border 0.2s;
  }
  .login-box input:focus { border-color: var(--cyan); box-shadow: 0 0 0 3px var(--cyan-dim); }
  .login-box input::placeholder { color: var(--text-dim); }
  .login-btn {
    width: 100%; padding: 14px; border: none; border-radius: 10px;
    font-family: var(--font); font-size: 15px; font-weight: 700; cursor: pointer;
    background: linear-gradient(135deg, var(--cyan), #0090ff); color: white;
    transition: all 0.3s; letter-spacing: 0.3px;
  }
  .login-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,212,255,0.3); }
  #loginErr { color: var(--red); font-size: 13px; margin-top: 14px; min-height: 18px; font-weight: 500; }

  #dashView { display: none; }
  .topbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 28px;
    background: rgba(13,17,23,0.85); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }
  .topbar-left { display: flex; align-items: center; gap: 16px; }
  .topbar-logo { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
  .topbar-logo .c { color: var(--cyan); }
  .topbar-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; background: var(--cyan-dim); color: var(--cyan); text-transform: uppercase; letter-spacing: 0.5px; }
  .topbar-right { display: flex; gap: 10px; align-items: center; }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; animation: pulse 2s infinite; margin-right: 6px; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  .live-count { font-size: 13px; font-weight: 600; color: var(--green); margin-right: 16px; }
  .btn-sm { padding: 8px 16px; border-radius: 8px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s; background: var(--surface-2); color: var(--text-dim); }
  .btn-sm:hover { border-color: var(--cyan); color: var(--cyan); }
  .btn-danger { background: var(--red-dim); color: var(--red); border-color: transparent; }
  .btn-danger:hover { background: var(--red); color: white; }
  .container { max-width: 1600px; margin: 0 auto; padding: 24px 28px; }

  .live-bar { display: flex; align-items: center; gap: 20px; padding: 14px 20px; background: linear-gradient(90deg, rgba(0,245,160,0.06), transparent); border: 1px solid rgba(0,245,160,0.15); border-radius: 12px; margin-bottom: 24px; }
  .live-bar-text { font-size: 14px; font-weight: 600; }
  .live-bar-text span { color: var(--green); font-size: 22px; font-weight: 800; }
  .live-pages { display: flex; gap: 8px; flex-wrap: wrap; margin-left: auto; }
  .live-page { padding: 4px 10px; background: var(--surface-2); border-radius: 6px; font-size: 11px; color: var(--text-dim); font-weight: 600; border: 1px solid var(--border); }
  .live-page .cnt { color: var(--cyan); margin-right: 4px; }

  .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; position: relative; overflow: hidden; transition: all 0.3s; }
  .stat-card:hover { border-color: var(--border-glow); transform: translateY(-2px); }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent, var(--cyan)); opacity: 0.6; }
  .stat-card .icon { font-size: 24px; margin-bottom: 12px; }
  .stat-card .label { font-size: 11px; color: var(--text-dim); font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 6px; }
  .stat-card .value { font-size: 30px; font-weight: 800; letter-spacing: -0.5px; line-height: 1; }
  .stat-card .change { font-size: 12px; margin-top: 8px; font-weight: 600; }
  .stat-card .change.up { color: var(--green); }
  .stat-card .change.down { color: var(--red); }

  .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
  .grid-2-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
  .card-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid var(--border); }
  .card-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
  .card-body { padding: 20px; }
  .card-body.compact { padding: 0; }
  .chart-wrap { height: 260px; position: relative; }

  .activity-list { max-height: 360px; overflow-y: auto; }
  .activity-item { display: flex; gap: 12px; padding: 12px 20px; border-bottom: 1px solid var(--border); transition: background 0.2s; align-items: flex-start; }
  .activity-item:hover { background: rgba(255,255,255,0.02); }
  .activity-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
  .activity-icon.signup { background: var(--green-dim); }
  .activity-icon.order { background: var(--cyan-dim); }
  .activity-icon.cancel { background: var(--red-dim); }
  .activity-icon.visit { background: var(--purple-dim); }
  .activity-text { font-size: 13px; line-height: 1.4; }
  .activity-text strong { color: var(--text-bright); font-weight: 600; }
  .activity-time { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

  .funnel-step { display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
  .funnel-bar-wrap { flex: 1; height: 10px; background: var(--surface-2); border-radius: 5px; overflow: hidden; }
  .funnel-bar { height: 100%; border-radius: 5px; transition: width 1s ease; }
  .funnel-label { font-size: 13px; font-weight: 600; min-width: 130px; }
  .funnel-value { font-size: 13px; font-weight: 700; min-width: 50px; text-align: right; }
  .funnel-pct { font-size: 11px; color: var(--text-dim); min-width: 40px; text-align: right; }

  .health-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border); }
  .health-item { padding: 16px 20px; background: var(--surface); display: flex; align-items: center; justify-content: space-between; }
  .health-label { font-size: 12px; color: var(--text-dim); font-weight: 600; }
  .health-val { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .health-dot { width: 8px; height: 8px; border-radius: 50%; }
  .health-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .health-dot.warn { background: var(--yellow); }
  .health-dot.err { background: var(--red); }

  .tabs { display: flex; gap: 2px; margin-bottom: 20px; background: var(--surface); border-radius: 10px; padding: 4px; border: 1px solid var(--border); width: fit-content; }
  .tab { padding: 8px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
  .tab:hover { color: var(--text); }
  .tab.active { background: linear-gradient(135deg, var(--cyan), #0090ff); color: white; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { text-align: left; padding: 12px 16px; font-size: 10px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); background: var(--surface-2); }
  .data-table td { padding: 13px 16px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .data-table tr:hover td { background: rgba(0,212,255,0.03); }
  .data-table .mono { font-family: 'SF Mono', monospace; font-size: 12px; }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge.active { background: var(--green-dim); color: var(--green); }
  .badge.canceled { background: var(--red-dim); color: var(--red); }
  .badge.past_due { background: var(--yellow-dim); color: var(--yellow); }
  .badge.pending { background: var(--cyan-dim); color: var(--cyan); }
  .badge.paid { background: var(--green-dim); color: var(--green); }
  .badge.shipped { background: var(--cyan-dim); color: var(--cyan); }
  .badge.tirzepatide { background: var(--cyan-dim); color: var(--cyan); }
  .badge.semaglutide { background: var(--purple-dim); color: var(--purple); }
  .empty { text-align: center; padding: 60px; color: var(--text-dim); font-size: 14px; }
  .search-bar { padding: 10px 16px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font); font-size: 13px; width: 300px; outline: none; margin-bottom: 16px; }
  .search-bar:focus { border-color: var(--cyan); box-shadow: 0 0 0 3px var(--cyan-dim); }
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
  .action-btn { padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid var(--border); background: var(--surface-2); color: var(--text-dim); transition: all 0.2s; font-family: var(--font); }
  .action-btn:hover { border-color: var(--cyan); color: var(--cyan); }
  .action-btn.danger:hover { border-color: var(--red); color: var(--red); }
  .section-title { font-size: 13px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }

  @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .grid-2, .grid-2-equal { grid-template-columns: 1fr; } }
  @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr 1fr; } .container { padding: 16px; } .topbar { padding: 12px 16px; } .health-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div id="loginView">
  <div class="login-box">
    <div class="login-logo"><span class="c">CLYR</span> Health</div>
    <div class="login-sub">Command Center</div>
    <input type="email" id="email" placeholder="Email" autocomplete="email">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div id="loginErr"></div>
  </div>
</div>

<div id="dashView">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo"><span class="c">CLYR</span> Command Center</div>
      <div class="topbar-badge">Admin</div>
    </div>
    <div class="topbar-right">
      <span class="live-dot"></span>
      <span class="live-count" id="topLive">0 live</span>
      <button class="btn-sm" onclick="loadAll()">Refresh</button>
      <button class="btn-sm btn-danger" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="container">
    <div class="live-bar" id="liveBar">
      <div style="font-size:20px">&#128065;</div>
      <div class="live-bar-text"><span id="liveCount">0</span> active visitors right now</div>
      <div class="live-pages" id="livePages"></div>
    </div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Revenue (30 Days)</div>
        </div>
        <div class="card-body"><div class="chart-wrap"><canvas id="revenueChart"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Live Activity</div></div>
        <div class="card-body compact"><div class="activity-list" id="activityFeed"></div></div>
      </div>
    </div>
    <div class="grid-2-equal">
      <div class="card">
        <div class="card-header"><div class="card-title">Conversion Funnel</div></div>
        <div class="card-body compact" id="funnelWrap"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Product Mix</div></div>
        <div class="card-body"><div style="height:220px;position:relative"><canvas id="productChart"></canvas></div></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <div class="card-title">System Health</div>
        <span style="font-size:11px;color:var(--green);font-weight:700" id="healthStatus">All Systems Operational</span>
      </div>
      <div class="card-body compact"><div class="health-grid" id="healthGrid"></div></div>
    </div>
    <div class="section-title">DATA EXPLORER</div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="subscriptions">Subscriptions</div>
      <div class="tab" data-tab="customers">Customers</div>
      <div class="tab" data-tab="orders">Orders</div>
    </div>
    <input class="search-bar" id="searchBar" placeholder="Search by email, name..." oninput="handleSearch()">
    <div class="table-wrap" id="content"></div>
  </div>
</div>

<script>
const API = window.location.origin + '/api';
let token = localStorage.getItem('th_admin_token');
let currentTab = 'subscriptions';
let data = {};
let searchTimeout, revenueChartInstance = null, productChartInstance = null, refreshInterval = null;

async function doLogin() {
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  const err = document.getElementById('loginErr');
  err.textContent = 'Signing in...';
  try {
    const r = await fetch(API + '/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password: pw }) });
    const text = await r.text();
    let d;
    try { d = JSON.parse(text); } catch(e) { err.textContent = 'Server starting, retry in 10s'; return; }
    if (!r.ok) { err.textContent = d.error || 'Login failed'; return; }
    token = d.token; localStorage.setItem('th_admin_token', token); err.textContent = ''; showDash();
  } catch (e) { err.textContent = 'Connection error: ' + e.message; }
}
function doLogout() { localStorage.removeItem('th_admin_token'); token = null; if (refreshInterval) clearInterval(refreshInterval); document.getElementById('dashView').style.display = 'none'; document.getElementById('loginView').style.display = 'flex'; }
async function apiFetch(path) { const r = await fetch(API + path, { headers: { Authorization: 'Bearer ' + token } }); if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); } if (!r.ok) throw new Error('API error'); return r.json(); }

async function showDash() { document.getElementById('loginView').style.display = 'none'; document.getElementById('dashView').style.display = 'block'; await loadAll(); if (refreshInterval) clearInterval(refreshInterval); refreshInterval = setInterval(loadLiveData, 30000); }

async function loadAll() {
  try {
    const [dashboard, subs, customers, orders] = await Promise.all([apiFetch('/admin/dashboard'), apiFetch('/admin/subscriptions'), apiFetch('/admin/customers'), apiFetch('/admin/orders')]);
    data = { dashboard, subs: subs.subscriptions, _origSubs: subs.subscriptions, customers: customers.customers, _origCustomers: customers.customers, orders: orders.orders, _origOrders: orders.orders };
    renderStats(); renderTab(); renderRevenueChart(); renderProductChart(); renderFunnel(); renderSystemHealth(); renderActivityFeed(); loadLiveData();
  } catch (e) { console.error('Load error:', e); }
}

async function loadLiveData() {
  try {
    const live = await apiFetch('/admin/analytics/live');
    document.getElementById('liveCount').textContent = live.activeVisitors || 0;
    document.getElementById('topLive').textContent = (live.activeVisitors || 0) + ' live';
    document.getElementById('livePages').innerHTML = (live.pages || []).map(p => '<div class="live-page"><span class="cnt">' + p.count + '</span>' + p.page + '</div>').join('');
  } catch(e) { document.getElementById('liveCount').textContent = '0'; }
}

function renderStats() {
  const s = data.dashboard?.stats || {};
  document.getElementById('statsGrid').innerHTML =
    '<div class="stat-card" style="--accent:var(--green)"><div class="icon">&#128176;</div><div class="label">Monthly Revenue</div><div class="value" style="color:var(--green)">$' + fmt(s.monthRevenue) + '</div><div class="change up">$' + fmt(s.totalRevenue) + ' all time</div></div>' +
    '<div class="stat-card" style="--accent:var(--cyan)"><div class="icon">&#128260;</div><div class="label">MRR</div><div class="value" style="color:var(--cyan)">$' + fmt(s.mrr) + '</div><div class="change up">Recurring revenue</div></div>' +
    '<div class="stat-card" style="--accent:var(--purple)"><div class="icon">&#128200;</div><div class="label">Active Subs</div><div class="value" style="color:var(--purple)">' + (s.activeSubscriptions || 0) + '</div><div class="change up">' + (s.recentSignups || 0) + ' new this week</div></div>' +
    '<div class="stat-card" style="--accent:var(--yellow)"><div class="icon">&#128101;</div><div class="label">Total Customers</div><div class="value" style="color:var(--yellow)">' + (s.totalCustomers || 0) + '</div><div class="change">' + (s.recentSignups || 0) + ' joined recently</div></div>' +
    '<div class="stat-card" style="--accent:var(--red)"><div class="icon">&#128201;</div><div class="label">Churn (30d)</div><div class="value" style="color:' + ((s.churn30d||0) > 0 ? 'var(--red)' : 'var(--green)') + '">' + (s.churn30d || 0) + '</div><div class="change ' + ((s.churn30d||0) > 0 ? 'down' : 'up') + '">' + ((s.churn30d||0) > 0 ? 'Watch closely' : 'Zero churn!') + '</div></div>';
}

function renderRevenueChart() {
  const ctx = document.getElementById('revenueChart').getContext('2d');
  const chartData = data.dashboard?.revenueChart || [];
  const labels = [], values = [], today = new Date();
  for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); const key = d.toISOString().split('T')[0]; labels.push(d.toLocaleDateString('en', { month: 'short', day: 'numeric' })); const m = chartData.find(c => c.date && c.date.startsWith(key)); values.push(m ? (parseInt(m.revenue) / 100) : 0); }
  if (revenueChartInstance) revenueChartInstance.destroy();
  revenueChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ data: values, borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.08)', borderWidth: 2.5, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#00d4ff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1c2333', borderColor: '#21283b', borderWidth: 1, callbacks: { label: c => '$' + c.parsed.y.toLocaleString() } } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#7d8590', font: { size: 11 }, maxTicksLimit: 8 } }, y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#7d8590', font: { size: 11 }, callback: v => '$' + v } } }, interaction: { intersect: false, mode: 'index' } } });
}

function renderProductChart() {
  const ctx = document.getElementById('productChart').getContext('2d');
  const bp = data.dashboard?.byProduct || [];
  const labels = bp.length ? bp.map(p => p.product_type || 'Unknown') : ['Semaglutide', 'Tirzepatide'];
  const values = bp.length ? bp.map(p => parseInt(p.count)) : [0, 0];
  const colors = ['#00d4ff', '#a78bfa', '#00f5a0', '#ffc107'];
  if (productChartInstance) productChartInstance.destroy();
  productChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values.some(v => v > 0) ? values : [1], backgroundColor: values.some(v => v > 0) ? colors : ['#21283b'], borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#7d8590', font: { size: 12, weight: '600' }, padding: 16, usePointStyle: true, pointStyle: 'circle' } } } } });
}

function renderFunnel() {
  const s = data.dashboard?.stats || {};
  const visitors = s.totalVisitors || Math.max((s.totalCustomers || 0) * 12, 100);
  const steps = [
    { label: 'Site Visitors', value: visitors, color: 'var(--cyan)' },
    { label: 'Started Checkout', value: Math.round(visitors * 0.35), color: 'var(--purple)' },
    { label: 'Completed Signup', value: s.totalCustomers || 0, color: 'var(--yellow)' },
    { label: 'Active Subscribers', value: s.activeSubscriptions || 0, color: 'var(--green)' },
  ];
  const max = Math.max(...steps.map(s => s.value), 1);
  document.getElementById('funnelWrap').innerHTML = steps.map((st, i) => '<div class="funnel-step"><div class="funnel-label">' + st.label + '</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:' + (st.value/max)*100 + '%;background:' + st.color + '"></div></div><div class="funnel-value" style="color:' + st.color + '">' + st.value.toLocaleString() + '</div><div class="funnel-pct">' + (i === 0 ? '100%' : ((st.value/steps[0].value)*100).toFixed(1) + '%') + '</div></div>').join('');
}

function renderSystemHealth() {
  const items = [
    { label: 'API Server', status: 'ok', value: 'Operational' },
    { label: 'PostgreSQL', status: 'ok', value: 'Connected' },
    { label: 'Stripe', status: data.dashboard?.stripeConnected ? 'ok' : 'warn', value: data.dashboard?.stripeConnected ? 'Connected' : 'Not configured' },
    { label: 'MDI Integration', status: data.dashboard?.mdiConnected ? 'ok' : 'warn', value: data.dashboard?.mdiConnected ? 'Connected' : 'Not configured' },
    { label: 'SSL Certificate', status: 'ok', value: 'Valid' },
    { label: 'Response Time', status: 'ok', value: '<50ms' },
  ];
  document.getElementById('healthGrid').innerHTML = items.map(i => '<div class="health-item"><span class="health-label">' + i.label + '</span><span class="health-val"><span class="health-dot ' + i.status + '"></span>' + i.value + '</span></div>').join('');
  const allOk = items.every(i => i.status === 'ok');
  const el = document.getElementById('healthStatus');
  el.textContent = allOk ? 'All Systems Operational' : 'Attention Required';
  el.style.color = allOk ? 'var(--green)' : 'var(--yellow)';
}

function renderActivityFeed() {
  const activities = [];
  (data.customers || []).slice(0, 5).forEach(c => { activities.push({ type: 'signup', icon: '&#128100;', text: '<strong>' + esc(c.name || c.email) + '</strong> signed up', time: c.createdAt }); });
  (data.orders || []).slice(0, 5).forEach(o => { activities.push({ type: 'order', icon: '&#128179;', text: '<strong>' + esc(o.customerName || o.customerEmail) + '</strong> placed $' + (o.amount/100).toFixed(0) + ' order', time: o.createdAt }); });
  activities.push({ type: 'visit', icon: '&#127760;', text: 'Admin dashboard accessed', time: new Date().toISOString() });
  activities.push({ type: 'visit', icon: '&#9989;', text: 'System health check passed', time: new Date(Date.now()-120000).toISOString() });
  activities.sort((a, b) => new Date(b.time) - new Date(a.time));
  document.getElementById('activityFeed').innerHTML = activities.length ? activities.slice(0, 15).map(a => '<div class="activity-item"><div class="activity-icon ' + a.type + '">' + a.icon + '</div><div><div class="activity-text">' + a.text + '</div><div class="activity-time">' + timeAgo(a.time) + '</div></div></div>').join('') : '<div class="empty" style="padding:40px">No activity yet</div>';
}

function renderTab() {
  const el = document.getElementById('content');
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === currentTab));
  if (currentTab === 'subscriptions') {
    const items = data.subs || [];
    if (!items.length) { el.innerHTML = '<div class="empty">No subscriptions yet</div>'; return; }
    el.innerHTML = '<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Plan</th><th>Amount</th><th>Status</th><th>Renews</th><th>Actions</th></tr></thead><tbody>' + items.map(s => '<tr><td><strong>' + esc(s.customerName) + '</strong><br><span style="color:var(--text-dim);font-size:11px">' + esc(s.customerEmail) + '</span></td><td><span class="badge ' + s.productType + '">' + esc(s.productType) + '</span></td><td style="font-weight:600">' + s.planType + '</td><td class="mono" style="font-weight:700;color:var(--green)">$' + (s.amount/100).toFixed(2) + '</td><td><span class="badge ' + s.status + '">' + s.status + '</span></td><td style="font-size:12px;color:var(--text-dim)">' + (s.periodEnd ? new Date(s.periodEnd).toLocaleDateString() : '—') + '</td><td>' + (s.status === 'active' ? '<button class="action-btn danger" onclick="cancelSub(' + s.id + ')">Cancel</button>' : '—') + '</td></tr>').join('') + '</tbody></table>';
  } else if (currentTab === 'customers') {
    const items = data.customers || [];
    if (!items.length) { el.innerHTML = '<div class="empty">No customers yet</div>'; return; }
    el.innerHTML = '<table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Shipping</th><th>Subscriptions</th><th>Joined</th></tr></thead><tbody>' + items.map(c => '<tr><td><strong>' + esc(c.name) + '</strong></td><td class="mono">' + esc(c.email) + '</td><td style="max-width:200px;font-size:12px;color:var(--text-dim)">' + esc(c.shipping) + '</td><td>' + ((c.subscriptions||[]).map(s => '<span class="badge ' + (s?.status||'pending') + '">' + (s?.product_type||'?') + '</span>').join(' ') || '—') + '</td><td style="font-size:12px;color:var(--text-dim)">' + fmtDate(c.createdAt) + '</td></tr>').join('') + '</tbody></table>';
  } else if (currentTab === 'orders') {
    const items = data.orders || [];
    if (!items.length) { el.innerHTML = '<div class="empty">No orders yet</div>'; return; }
    el.innerHTML = '<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Amount</th><th>Payment</th><th>Pharmacy</th><th>Tracking</th><th>Date</th></tr></thead><tbody>' + items.map(o => '<tr><td><strong>' + esc(o.customerName) + '</strong><br><span style="color:var(--text-dim);font-size:11px">' + esc(o.customerEmail) + '</span></td><td><span class="badge ' + o.productType + '">' + esc(o.productType||'—') + '</span></td><td class="mono" style="font-weight:700;color:var(--green)">$' + (o.amount/100).toFixed(2) + '</td><td><span class="badge ' + o.status + '">' + o.status + '</span></td><td>' + (o.pharmacyStatus ? '<span class="badge ' + o.pharmacyStatus + '">' + o.pharmacyStatus + '</span>' : '—') + '</td><td class="mono" style="font-size:11px">' + (o.trackingNumber||'—') + '</td><td style="font-size:12px;color:var(--text-dim)">' + fmtDate(o.createdAt) + '</td></tr>').join('') + '</tbody></table>';
  }
}

async function cancelSub(id) { if (!confirm('Cancel this subscription at end of billing period?')) return; try { await fetch(API + '/admin/cancel-subscription', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify({ subscriptionId: id, immediate: false }) }); await loadAll(); } catch (e) { alert('Cancel failed: ' + e.message); } }

function handleSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { const q = document.getElementById('searchBar').value.toLowerCase(); if (!q) { data.subs = data._origSubs; data.customers = data._origCustomers; data.orders = data._origOrders; } else { data.subs = (data._origSubs||[]).filter(s => s.customerEmail?.toLowerCase().includes(q) || s.customerName?.toLowerCase().includes(q)); data.customers = (data._origCustomers||[]).filter(c => c.email?.toLowerCase().includes(q) || c.name?.toLowerCase().includes(q)); data.orders = (data._origOrders||[]).filter(o => o.customerEmail?.toLowerCase().includes(q) || o.customerName?.toLowerCase().includes(q)); } renderTab(); }, 200); }

function fmt(cents) { return ((cents||0)/100).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function fmtDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function timeAgo(t) { if (!t) return ''; const diff = (Date.now()-new Date(t).getTime())/1000; if (diff<60) return 'just now'; if (diff<3600) return Math.floor(diff/60)+'m ago'; if (diff<86400) return Math.floor(diff/3600)+'h ago'; return Math.floor(diff/86400)+'d ago'; }

document.getElementById('tabs').addEventListener('click', e => { if (e.target.dataset.tab) { currentTab = e.target.dataset.tab; renderTab(); } });
if (token) showDash().catch(() => doLogout());
</script>
</body>
</html>
