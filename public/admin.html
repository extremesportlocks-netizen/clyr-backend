<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLYR Health — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
:root{
--bg:#050507;--surface:rgba(255,255,255,0.03);--glass:rgba(255,255,255,0.04);--glass-border:rgba(255,255,255,0.08);--glass-hover:rgba(255,255,255,0.14);
--cyan:#00d4ff;--cyan-dim:rgba(0,212,255,0.1);--green:#34d399;--green-dim:rgba(52,211,153,0.1);--green-glow:rgba(52,211,153,0.25);
--purple:#a78bfa;--purple-dim:rgba(167,139,250,0.1);--rose:#fb7185;--rose-dim:rgba(251,113,133,0.1);
--amber:#fbbf24;--amber-dim:rgba(251,191,36,0.1);
--text:rgba(255,255,255,0.9);--text-dim:rgba(255,255,255,0.4);--text-muted:rgba(255,255,255,0.25);
--font:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace;
--sidebar-w:240px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 20%,rgba(0,212,255,0.03) 0%,transparent 50%),radial-gradient(circle at 70% 80%,rgba(167,139,250,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:10px}

/* LOGIN */
#loginView{display:flex;align-items:center;justify-content:center;min-height:100vh;position:relative;z-index:1}
.login-box{background:var(--glass);backdrop-filter:blur(40px);border:1px solid var(--glass-border);border-radius:28px;padding:56px 48px;width:440px;text-align:center;animation:fadeUp .8s ease}
.login-logo{font-size:42px;font-weight:900;letter-spacing:-2px;margin-bottom:4px;background:linear-gradient(135deg,#fff 0%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{color:var(--text-dim);font-size:13px;margin-bottom:36px;font-weight:500;letter-spacing:2px;text-transform:uppercase}
.login-box input{width:100%;padding:16px 20px;margin-bottom:14px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);border-radius:14px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;transition:all .3s}
.login-box input:focus{border-color:var(--cyan);background:rgba(0,212,255,0.04);box-shadow:0 0 0 4px rgba(0,212,255,0.08)}
.login-box input::placeholder{color:var(--text-muted)}
.login-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:var(--font);font-size:15px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff;transition:all .3s;position:relative;overflow:hidden}
.login-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);transition:.6s}
.login-btn:hover::after{left:100%}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,212,255,0.3)}
#loginErr{color:var(--rose);font-size:13px;margin-top:16px;min-height:18px;font-weight:500}

/* LAYOUT */
#dashView{display:none;position:relative;z-index:1}
.app-layout{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);position:fixed;top:0;left:0;bottom:0;z-index:200;background:rgba(8,8,12,0.9);backdrop-filter:blur(30px);border-right:1px solid var(--glass-border);display:flex;flex-direction:column;padding:0;overflow-y:auto}
.sidebar-brand{padding:24px 24px 20px;border-bottom:1px solid var(--glass-border)}
.sidebar-brand-text{font-size:22px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,#fff,var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-brand-sub{font-size:10px;color:var(--text-muted);font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-top:4px}
.sidebar-nav{flex:1;padding:16px 12px}
.sidebar-section{font-size:10px;font-weight:700;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;padding:16px 12px 8px;margin-top:4px}
.sidebar-item{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:12px;cursor:pointer;transition:all .25s;margin-bottom:2px;color:var(--text-dim);font-size:13px;font-weight:600;position:relative;border:1px solid transparent}
.sidebar-item:hover{background:rgba(255,255,255,0.04);color:var(--text)}
.sidebar-item.active{background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(0,102,255,0.06));color:var(--cyan);border-color:rgba(0,212,255,0.15)}
.sidebar-item.active::before{content:'';position:absolute;left:-13px;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--cyan);border-radius:0 3px 3px 0;box-shadow:0 0 8px rgba(0,212,255,0.4)}
.sidebar-icon{width:20px;text-align:center;font-size:15px;flex-shrink:0}
.sidebar-badge{margin-left:auto;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:800;background:var(--cyan-dim);color:var(--cyan);font-family:var(--mono)}
.sidebar-footer{padding:16px;border-top:1px solid var(--glass-border)}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s}
.sidebar-user:hover{background:rgba(255,255,255,0.04)}
.sidebar-avatar{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--cyan),#0066ff);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff}
.sidebar-user-info{flex:1}
.sidebar-user-name{font-size:12px;font-weight:700;color:var(--text)}
.sidebar-user-role{font-size:10px;color:var(--text-muted);font-weight:500}

/* MAIN CONTENT */
.main-content{margin-left:var(--sidebar-w);flex:1;min-height:100vh}
.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:rgba(5,5,7,0.7);backdrop-filter:blur(30px);border-bottom:1px solid var(--glass-border)}
.topbar-title{font-size:18px;font-weight:800;letter-spacing:-.5px}
.hamburger{display:none;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:8px}
.hamburger span{display:block;width:20px;height:2px;background:var(--text);border-radius:2px}
.sidebar-overlay{display:none}
.topbar-right{display:flex;gap:10px;align-items:center}
.live-indicator{display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15)}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;box-shadow:0 0 8px var(--green)}
.live-count{font-size:12px;font-weight:700;color:var(--green)}
.btn{padding:9px 18px;border-radius:10px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--glass-border);transition:all .3s;background:var(--glass);color:var(--text-dim)}
.btn:hover{border-color:var(--glass-hover);color:var(--text)}
.btn-danger{border-color:rgba(251,113,133,0.2);color:var(--rose);background:rgba(251,113,133,0.06)}
.btn-danger:hover{background:var(--rose);color:#fff}

/* PAGES */
.page{display:none;padding:28px 32px;max-width:1400px;animation:fadeUp .4s ease}
.page.active{display:block}
.container{max-width:1400px}

/* GLASS CARD */
.glass{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;transition:all .4s;overflow:hidden}
.glass:hover{border-color:var(--glass-hover)}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px}
.stat-card{position:relative;padding:22px;border-radius:20px;overflow:hidden;transition:all .4s;border:1px solid var(--glass-border);animation:fadeUp .6s ease backwards}
.stat-card:nth-child(1){animation-delay:.05s}.stat-card:nth-child(2){animation-delay:.1s}.stat-card:nth-child(3){animation-delay:.15s}
.stat-card:nth-child(4){animation-delay:.2s}.stat-card:nth-child(5){animation-delay:.25s}.stat-card:nth-child(6){animation-delay:.3s}
.stat-card::before{content:'';position:absolute;inset:0;opacity:.6;z-index:0;border-radius:20px}
.stat-card:hover{transform:translateY(-4px);border-color:var(--glass-hover)}
.stat-card.mint::before{background:linear-gradient(135deg,rgba(52,211,153,0.08),rgba(52,211,153,0.02))}
.stat-card.cyan::before{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(0,212,255,0.02))}
.stat-card.purple::before{background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(167,139,250,0.02))}
.stat-card.amber::before{background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(251,191,36,0.02))}
.stat-card.blue::before{background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(96,165,250,0.02))}
.stat-card.rose::before{background:linear-gradient(135deg,rgba(251,113,133,0.08),rgba(251,113,133,0.02))}
.stat-card *{position:relative;z-index:1}
.stat-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:16px;margin-bottom:12px;border:1px solid var(--glass-border)}
.stat-card.mint .stat-icon{background:var(--green-dim)}.stat-card.cyan .stat-icon{background:var(--cyan-dim)}
.stat-card.purple .stat-icon{background:var(--purple-dim)}.stat-card.amber .stat-icon{background:var(--amber-dim)}
.stat-card.blue .stat-icon{background:rgba(96,165,250,0.1)}.stat-card.rose .stat-icon{background:var(--rose-dim)}
.stat-label{font-size:10px;color:var(--text-dim);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.stat-value{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1;font-family:var(--mono)}
.stat-card.mint .stat-value{color:var(--green)}.stat-card.cyan .stat-value{color:var(--cyan)}
.stat-card.purple .stat-value{color:var(--purple)}.stat-card.amber .stat-value{color:var(--amber)}
.stat-card.blue .stat-value{color:#60a5fa}.stat-card.rose .stat-value{color:var(--rose)}
.stat-sub{font-size:11px;color:var(--text-dim);margin-top:6px;font-weight:500}
.stat-sub .up{color:var(--green)}.stat-sub .down{color:var(--rose)}

.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
.grid-2-equal{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--glass-border)}
.card-title{font-size:14px;font-weight:700}.card-body{padding:24px}.card-body.compact{padding:0}
.chart-wrap{height:270px;position:relative}
.select-sm{background:var(--glass);border:1px solid var(--glass-border);color:var(--text-dim);padding:6px 12px;border-radius:8px;font-size:11px;font-family:var(--font);font-weight:600;cursor:pointer}

.live-bar{display:flex;align-items:center;gap:20px;padding:16px 24px;background:linear-gradient(135deg,rgba(52,211,153,0.04),rgba(0,212,255,0.02));border:1px solid rgba(52,211,153,0.1);border-radius:16px;margin-bottom:28px}
.live-bar-num{font-size:28px;font-weight:900;color:var(--green);font-family:var(--mono)}
.live-bar-label{font-size:13px;color:var(--text-dim);font-weight:500}
.live-pages{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
.live-page{padding:5px 12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;font-size:11px;color:var(--text-dim);font-weight:600;font-family:var(--mono)}
.live-page .cnt{color:var(--cyan);margin-right:6px}

.activity-list{max-height:370px;overflow-y:auto}
.activity-item{display:flex;gap:14px;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,0.03);align-items:flex-start}
.activity-item:hover{background:rgba(255,255,255,0.02)}
.activity-dot{width:8px;height:8px;border-radius:50%;margin-top:6px;flex-shrink:0}
.activity-dot.signup{background:var(--green);box-shadow:0 0 6px var(--green-glow)}
.activity-dot.order{background:var(--cyan);box-shadow:0 0 6px rgba(0,212,255,0.3)}
.activity-dot.visit{background:var(--purple);box-shadow:0 0 6px rgba(167,139,250,0.3)}
.activity-text{font-size:13px;line-height:1.5;color:var(--text-dim)}.activity-text strong{color:var(--text);font-weight:600}
.activity-time{font-size:10px;color:var(--text-muted);margin-top:2px;font-family:var(--mono)}

.funnel-step{display:flex;align-items:center;gap:16px;padding:16px 24px;border-bottom:1px solid rgba(255,255,255,0.03)}
.funnel-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden}
.funnel-bar{height:100%;border-radius:4px;transition:width 1.2s cubic-bezier(.23,1,.32,1)}
.funnel-label{font-size:13px;font-weight:600;min-width:150px}.funnel-value{font-size:14px;font-weight:800;min-width:50px;text-align:right;font-family:var(--mono)}
.funnel-pct{font-size:11px;color:var(--text-muted);min-width:45px;text-align:right;font-family:var(--mono)}

.health-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:rgba(255,255,255,0.03)}
.health-item{padding:18px 24px;background:var(--bg);display:flex;align-items:center;justify-content:space-between}
.health-label{font-size:12px;color:var(--text-dim);font-weight:600}
.health-val{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.health-dot{width:7px;height:7px;border-radius:50%}.health-dot.ok{background:var(--green);box-shadow:0 0 8px var(--green-glow)}.health-dot.warn{background:var(--amber);box-shadow:0 0 8px rgba(251,191,36,0.3)}

#mapContainer{height:450px;background:var(--bg)}
.leaflet-tile-pane{filter:brightness(0.5) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.6)}
.leaflet-container{background:var(--bg)!important}
.map-legend{display:flex;gap:20px;padding:14px 24px;border-top:1px solid var(--glass-border);font-size:11px;color:var(--text-dim)}
.map-legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}

.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--glass);border-radius:12px;padding:4px;border:1px solid var(--glass-border);width:fit-content}
.tab{padding:9px 22px;border-radius:10px;font-size:12px;font-weight:700;color:var(--text-dim);cursor:pointer;transition:all .3s}
.tab:hover{color:var(--text)}.tab.active{background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff}
.data-table{width:100%;border-collapse:collapse}
.data-table th{text-align:left;padding:14px 20px;font-size:10px;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;border-bottom:1px solid var(--glass-border);background:rgba(255,255,255,0.02)}
.data-table td{padding:14px 20px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
.data-table tr:hover td{background:rgba(0,212,255,0.02)}
.mono{font-family:var(--mono);font-size:12px}
.badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.badge.active{background:var(--green-dim);color:var(--green)}.badge.canceled{background:var(--rose-dim);color:var(--rose)}
.badge.past_due{background:var(--amber-dim);color:var(--amber)}.badge.pending,.badge.shipped{background:var(--cyan-dim);color:var(--cyan)}
.badge.paid{background:var(--green-dim);color:var(--green)}.badge.tirzepatide{background:var(--cyan-dim);color:var(--cyan)}.badge.semaglutide{background:var(--purple-dim);color:var(--purple)}
.empty{text-align:center;padding:60px;color:var(--text-muted);font-size:14px}
.search-bar{padding:11px 18px;background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:var(--font);font-size:13px;width:320px;outline:none;margin-bottom:16px;transition:all .3s}
.search-bar:focus{border-color:rgba(0,212,255,0.3);box-shadow:0 0 0 4px rgba(0,212,255,0.06)}
.table-wrap{border-radius:20px;overflow:hidden;border:1px solid var(--glass-border);background:var(--glass)}
.action-btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--glass-border);background:var(--glass);color:var(--text-dim);transition:all .3s;font-family:var(--font)}
.action-btn:hover{border-color:var(--cyan);color:var(--cyan)}.action-btn.danger:hover{border-color:var(--rose);color:var(--rose)}
.section-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px}
.page-coming{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center}
.page-coming-icon{font-size:48px;margin-bottom:20px;opacity:.5}
.page-coming-title{font-size:24px;font-weight:800;margin-bottom:8px;letter-spacing:-.5px}
.page-coming-sub{font-size:14px;color:var(--text-dim);max-width:400px;line-height:1.6}
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;display:none;backdrop-filter:blur(4px)}
.drawer-overlay.open{display:block}
.drawer{position:fixed;top:0;right:-560px;width:540px;height:100vh;background:rgba(12,12,18,0.97);backdrop-filter:blur(30px);border-left:1px solid var(--glass-border);z-index:501;transition:right .35s cubic-bezier(.23,1,.32,1);overflow-y:auto;display:flex;flex-direction:column}
.drawer.open{right:0}
.drawer-header{padding:20px 24px;border-bottom:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.drawer-title{font-size:16px;font-weight:800}
.drawer-body{padding:24px;flex:1;overflow-y:auto}
.detail-section{margin-bottom:24px}
.detail-section-title{font-size:10px;font-weight:800;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--glass-border)}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-item{padding:12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:12px}
.detail-item.full{grid-column:1/-1}
.detail-item-label{font-size:10px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.detail-item-value{font-size:14px;font-weight:600;word-break:break-word}
.status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.status-pill.green{background:var(--green-dim);color:var(--green)}
.status-pill.amber{background:var(--amber-dim);color:var(--amber)}
.status-pill.red{background:var(--rose-dim);color:var(--rose)}
.status-pill.cyan{background:var(--cyan-dim);color:var(--cyan)}
.status-pill.purple{background:var(--purple-dim);color:var(--purple)}
.timeline{position:relative;padding-left:20px}
.timeline::before{content:'';position:absolute;left:4px;top:8px;bottom:8px;width:1px;background:var(--glass-border)}
.timeline-item{position:relative;padding:8px 0 8px 16px;font-size:12px}
.timeline-item::before{content:'';position:absolute;left:-20px;top:12px;width:9px;height:9px;border-radius:50%;border:2px solid var(--glass-border);background:var(--bg)}
.timeline-item.done::before{background:var(--green);border-color:var(--green);box-shadow:0 0 6px var(--green-glow)}
.timeline-item.current::before{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 6px rgba(0,212,255,0.3)}
.timeline-item .tl-label{color:var(--text-dim);font-weight:500}.timeline-item .tl-date{color:var(--text-muted);font-size:10px;font-family:var(--mono)}
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(3,1fr)}.grid-2,.grid-2-equal{grid-template-columns:1fr}}
@media(max-width:900px){.sidebar{display:flex;transform:translateX(-100%);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:300}.sidebar.mobile-open{transform:translateX(0)}.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:250;transition:opacity .3s}.sidebar-overlay.active{display:block}.main-content{margin-left:0}.stats-grid{grid-template-columns:1fr 1fr}.health-grid{grid-template-columns:1fr}.hamburger{display:flex;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:8px;margin-right:8px}.hamburger span{display:block;width:20px;height:2px;background:var(--text);border-radius:2px;transition:all .3s}.tabs{overflow-x:auto;width:100%;flex-wrap:nowrap}.tab{white-space:nowrap;flex-shrink:0}.grid-2-equal{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="loginView">
  <div class="login-box">
    <div class="login-logo">CLYR Health</div>
    <div class="login-sub">Command Center</div>
    <input type="email" id="email" placeholder="Email" autocomplete="email">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div id="loginErr"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashView">
  <div class="app-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="sidebar-brand-text">CLYR</div>
        <div class="sidebar-brand-sub">Command Center</div>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-section">Main</div>
        <div class="sidebar-item active" data-page="dashboard" onclick="switchPage('dashboard')">
          <span class="sidebar-icon">&#9881;</span> Dashboard
        </div>
        <div class="sidebar-item" data-page="analytics" onclick="switchPage('analytics')">
          <span class="sidebar-icon">&#128200;</span> Analytics
        </div>
        <div class="sidebar-item" data-page="customers" onclick="switchPage('customers')">
          <span class="sidebar-icon">&#128101;</span> Customers <span class="sidebar-badge" id="custCount">0</span>
        </div>
        <div class="sidebar-item" data-page="orders" onclick="switchPage('orders')">
          <span class="sidebar-icon">&#128179;</span> Orders / Revenue
        </div>
        <div class="sidebar-section">Operations</div>
        <div class="sidebar-item" data-page="pharmacy" onclick="switchPage('pharmacy')">
          <span class="sidebar-icon">&#128138;</span> Pharmacy
        </div>
        <div class="sidebar-item" data-page="affiliates" onclick="switchPage('affiliates')">
          <span class="sidebar-icon">&#129309;</span> Affiliates
        </div>
        <div class="sidebar-item" data-page="marketing" onclick="switchPage('marketing')">
          <span class="sidebar-icon">&#128227;</span> Marketing
        </div>
        <div class="sidebar-section">System</div>
        <div class="sidebar-item" data-page="notifications" onclick="switchPage('notifications')">
          <span class="sidebar-icon">&#128276;</span> Notifications
        </div>
        <div class="sidebar-item" data-page="settings" onclick="switchPage('settings')">
          <span class="sidebar-icon">&#9881;</span> Settings
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="sidebar-user" onclick="doLogout()">
          <div class="sidebar-avatar">A</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name">Admin</div>
            <div class="sidebar-user-role">Sign Out</div>
          </div>
        </div>
      </div>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
    <div class="main-content">
      <div class="topbar">
        <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileSidebar()"><span></span><span></span><span></span></button>
        <div class="topbar-title" id="pageTitle">Dashboard</div>
        <div class="topbar-right">
          <div class="live-indicator"><span class="live-dot"></span><span class="live-count" id="topLive">0 live</span></div>
          <button class="btn" onclick="loadAll()">Refresh</button>
        </div>
      </div>

      <!-- PAGE: DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="live-bar"><div class="live-bar-num" id="liveCount">0</div><div><div class="live-bar-label">Active visitors right now</div></div><div class="live-pages" id="livePages"></div></div>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="grid-2">
          <div class="glass"><div class="card-header"><div class="card-title">Revenue Overview</div></div><div class="card-body"><div class="chart-wrap"><canvas id="revenueChart"></canvas></div></div></div>
          <div class="glass"><div class="card-header"><div class="card-title">Activity Feed</div></div><div class="card-body compact"><div class="activity-list" id="activityFeed"></div></div></div>
        </div>
        <div class="glass"><div class="card-header"><div class="card-title">System Health</div><span style="font-size:11px;font-weight:700" id="healthStatus"></span></div><div class="card-body compact"><div class="health-grid" id="healthGrid"></div></div></div>
      </div>

      <!-- PAGE: ANALYTICS -->
      <div class="page" id="page-analytics">
        <div class="grid-2-equal">
          <div class="glass"><div class="card-header"><div class="card-title">Conversion Funnel</div><select class="select-sm" id="funnelPeriod" onchange="loadFunnel()"><option value="7d">7 days</option><option value="14d">14 days</option><option value="30d" selected>30 days</option><option value="60d">60 days</option><option value="90d">90 days</option></select></div><div class="card-body compact" id="funnelWrap"></div></div>
          <div class="glass"><div class="card-header"><div class="card-title">Top 10 Traffic Sources</div><select class="select-sm" id="trafficPeriod" onchange="renderTrafficSources()"><option value="7d">7 days</option><option value="30d" selected>30 days</option><option value="all">All Time</option></select></div><div class="card-body"><div style="height:260px;position:relative"><canvas id="trafficChart"></canvas></div></div></div>
        </div>
        <div class="glass"><div class="card-header"><div class="card-title">Visitor Map</div><select class="select-sm" id="mapPeriod" onchange="loadGeoData()"><option value="1h">Last hour</option><option value="24h" selected>Last 24h</option><option value="7d">7 days</option><option value="30d">30 days</option></select></div><div id="mapContainer"></div><div class="map-legend"><span><span class="map-legend-dot" style="background:var(--green)"></span>Active now</span><span><span class="map-legend-dot" style="background:var(--cyan)"></span>Recent</span><span id="mapStats" style="margin-left:auto;font-weight:600;font-family:var(--mono)"></span></div></div>
      </div>

      <!-- PAGE: CUSTOMERS -->
      <div class="page" id="page-customers">
        <div class="stats-grid" id="custStats"></div>
        <div class="tabs" id="custTabs">
          <div class="tab active" data-ctab="all" onclick="switchCustTab('all')">All Customers</div>
          <div class="tab" data-ctab="intake" onclick="switchCustTab('intake')">Intake Completed</div>
          <div class="tab" data-ctab="active" onclick="switchCustTab('active')">Active Subs</div>
          <div class="tab" data-ctab="flagged" onclick="switchCustTab('flagged')">Flagged</div>
        </div>
        <input class="search-bar" id="custSearch" placeholder="Search by name, email, phone..." oninput="handleSearch()">
        <div class="table-wrap" id="custTable"></div>
        <!-- CUSTOMER DETAIL DRAWER -->
        <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
        <div class="drawer" id="custDrawer">
          <div class="drawer-header">
            <div class="drawer-title" id="drawerTitle">Customer Detail</div>
            <button class="btn" onclick="closeDrawer()" style="padding:6px 14px">✕</button>
          </div>
          <div class="drawer-body" id="drawerBody"></div>
        </div>
      </div>

      <!-- PAGE: ORDERS -->
      <div class="page" id="page-orders">
        <div class="stats-grid" id="orderStats"></div>
        <div class="grid-2-equal" style="margin-bottom:16px">
          <div class="glass"><div class="card-header"><div class="card-title">Product Mix</div></div><div class="card-body"><div style="height:220px;position:relative"><canvas id="productChart"></canvas></div></div></div>
          <div class="glass"><div class="card-header"><div class="card-title">Revenue by Product</div></div><div class="card-body"><div style="height:220px;position:relative"><canvas id="revenueByProductChart"></canvas></div></div></div>
        </div>
        <div class="tabs" id="orderTabs"><div class="tab active" data-otab="subscriptions" onclick="switchOrderTab('subscriptions')">Subscriptions</div><div class="tab" data-otab="orders" onclick="switchOrderTab('orders')">Orders</div></div>
        <input class="search-bar" id="orderSearch" placeholder="Search orders..." oninput="handleSearch()">
        <div class="table-wrap" id="orderTable"></div>
      </div>

      <!-- PAGE: PHARMACY -->
      <div class="page" id="page-pharmacy">
        <div class="page-coming"><div class="page-coming-icon">&#128138;</div><div class="page-coming-title">Pharmacy & Fulfillment</div><div class="page-coming-sub">Track prescription statuses, pharmacy processing, shipment tracking, and delivery confirmations. Connect your MDI integration to activate.</div></div>
      </div>

      <!-- PAGE: AFFILIATES -->
      <div class="page" id="page-affiliates">
        <div class="stats-grid" id="affStats"></div>
        <div class="tabs" id="affTabs">
          <div class="tab active" data-atab="overview" onclick="switchAffTab('overview')">Overview</div>
          <div class="tab" data-atab="partners" onclick="switchAffTab('partners')">Partners</div>
          <div class="tab" data-atab="leads" onclick="switchAffTab('leads')">Leads & Signups</div>
          <div class="tab" data-atab="commissions" onclick="switchAffTab('commissions')">Commissions</div>
          <div class="tab" data-atab="links" onclick="switchAffTab('links')">Link Generator</div>
          <div class="tab" data-atab="payouts" onclick="switchAffTab('payouts')">Payouts</div>
        </div>
        <div id="affContent"></div>
      </div>

      <!-- PAGE: MARKETING -->
      <div class="page" id="page-marketing">
        <div class="stats-grid" id="mktStats"></div>
        <div class="tabs" id="mktTabs">
          <div class="tab active" data-mtab="overview" onclick="switchMktTab('overview')">Overview</div>
          <div class="tab" data-mtab="channels" onclick="switchMktTab('channels')">Channels</div>
          <div class="tab" data-mtab="campaigns" onclick="switchMktTab('campaigns')">Campaigns</div>
          <div class="tab" data-mtab="utm" onclick="switchMktTab('utm')">UTM Tracker</div>
          <div class="tab" data-mtab="social" onclick="switchMktTab('social')">Social Media</div>
        </div>
        <div id="mktContent"></div>
      </div>

      <!-- PAGE: NOTIFICATIONS -->
      <div class="page" id="page-notifications">
        <div class="stats-grid" id="notifStats"></div>
        <div class="tabs" id="notifTabs">
          <div class="tab active" data-ntab="all" onclick="switchNotifTab('all')">All Alerts</div>
          <div class="tab" data-ntab="signups" onclick="switchNotifTab('signups')">New Signups</div>
          <div class="tab" data-ntab="payments" onclick="switchNotifTab('payments')">Payments</div>
          <div class="tab" data-ntab="intake" onclick="switchNotifTab('intake')">Intake Events</div>
          <div class="tab" data-ntab="system" onclick="switchNotifTab('system')">System</div>
          <div class="tab" data-ntab="settings" onclick="switchNotifTab('settings')">Settings</div>
        </div>
        <div id="notifContent"></div>
      </div>
      </div>

      <!-- PAGE: SETTINGS -->
      <div class="page" id="page-settings">
        <div class="page-coming"><div class="page-coming-icon">&#9881;</div><div class="page-coming-title">Settings</div><div class="page-coming-sub">Configure Stripe keys, MDI API integration, admin accounts, CORS origins, webhook URLs, and notification preferences. Coming soon.</div></div>
      </div>

    </div>
  </div>
</div>

<script>
const API=window.location.origin+'/api';let token=localStorage.getItem('th_admin_token'),currentPage='dashboard',orderTab='subscriptions',mktTab='overview',notifTab='all',affTab='overview',data={},searchTimeout,revenueChartInstance=null,productChartInstance=null,refreshInterval=null,visitorMap=null,mapMarkers=[];

// AUTH
async function doLogin(){const email=document.getElementById('email').value,pw=document.getElementById('password').value,err=document.getElementById('loginErr');err.textContent='Signing in...';try{const r=await fetch(API+'/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pw})});const text=await r.text();let d;try{d=JSON.parse(text)}catch(e){err.textContent='Server starting, retry in 10s';return}if(!r.ok){err.textContent=d.error||'Login failed';return}token=d.token;localStorage.setItem('th_admin_token',token);err.textContent='';showDash()}catch(e){err.textContent='Connection error: '+e.message}}
function doLogout(){localStorage.removeItem('th_admin_token');token=null;if(refreshInterval)clearInterval(refreshInterval);document.getElementById('dashView').style.display='none';document.getElementById('loginView').style.display='flex'}
async function apiFetch(path){const r=await fetch(API+path,{headers:{Authorization:'Bearer '+token}});if(r.status===401){doLogout();throw new Error('Unauthorized')}if(!r.ok)throw new Error('API error');return r.json()}

// NAVIGATION
function toggleMobileSidebar(){const sb=document.querySelector('.sidebar');const ov=document.getElementById('sidebarOverlay');sb.classList.toggle('mobile-open');ov.classList.toggle('active')}
function switchPage(page){currentPage=page;document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+page).classList.add('active');document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.toggle('active',i.dataset.page===page));const titles={dashboard:'Dashboard',analytics:'Analytics',customers:'Customers',orders:'Orders & Revenue',pharmacy:'Pharmacy & Fulfillment',affiliates:'Affiliates',marketing:'Marketing Hub',notifications:'Notifications',settings:'Settings'};document.getElementById('pageTitle').textContent=titles[page]||page;const sb=document.querySelector('.sidebar');const ov=document.getElementById('sidebarOverlay');if(sb)sb.classList.remove('mobile-open');if(ov)ov.classList.remove('active');if(page==='analytics'){setTimeout(()=>{if(visitorMap)visitorMap.invalidateSize();else initMap()},100);loadFunnel();loadGeoData();renderTrafficSources()}if(page==='customers')renderCustomersPage();if(page==='orders'){renderOrdersPage();renderProductChart();renderRevenueByProduct()}if(page==='affiliates'){renderAffiliatesPage()}if(page==='marketing'){renderMarketingPage()}if(page==='notifications'){renderNotificationsPage()}}

function switchOrderTab(tab){orderTab=tab;document.querySelectorAll('#orderTabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.otab===tab));renderOrderTable()}

// LOAD
async function showDash(){document.getElementById('loginView').style.display='none';document.getElementById('dashView').style.display='block';await loadAll();if(refreshInterval)clearInterval(refreshInterval);refreshInterval=setInterval(()=>loadLiveData(),30000)}
async function loadAll(){try{const[dashboard,subs,customers,orders]=await Promise.all([apiFetch('/admin/dashboard'),apiFetch('/admin/subscriptions'),apiFetch('/admin/customers'),apiFetch('/admin/orders')]);data={dashboard,subs:subs.subscriptions,_origSubs:subs.subscriptions,customers:customers.customers,_origCustomers:customers.customers,orders:orders.orders,_origOrders:orders.orders};document.getElementById('custCount').textContent=data.customers?.length||0;renderStats();renderRevenueChart();renderSystemHealth();renderActivityFeed();loadLiveData();if(currentPage==='analytics'){loadFunnel();loadGeoData();renderTrafficSources()}if(currentPage==='customers')renderCustomersPage();if(currentPage==='orders'){renderOrdersPage();renderProductChart();renderRevenueByProduct()}}catch(e){console.error('Load error:',e)}}
async function loadLiveData(){try{const live=await apiFetch('/admin/analytics/live');const el=document.getElementById('liveCount');if(el)el.textContent=live.activeVisitors||0;document.getElementById('topLive').textContent=(live.activeVisitors||0)+' live';const lp=document.getElementById('livePages');if(lp)lp.innerHTML=(live.pages||[]).map(p=>'<div class="live-page"><span class="cnt">'+p.count+'</span>'+esc(p.page)+'</div>').join('')}catch(e){}}

// STATS
function renderStats(){const s=data.dashboard?.stats||{};document.getElementById('statsGrid').innerHTML=
'<div class="stat-card mint"><div class="stat-icon">&#128176;</div><div class="stat-label">Monthly Revenue</div><div class="stat-value">$'+fmt(s.monthRevenue)+'</div><div class="stat-sub"><span class="up">$'+fmt(s.totalRevenue)+'</span> all time</div></div>'+
'<div class="stat-card cyan"><div class="stat-icon">&#9889;</div><div class="stat-label">MRR</div><div class="stat-value">$'+fmt(s.mrr)+'</div><div class="stat-sub">Recurring</div></div>'+
'<div class="stat-card purple"><div class="stat-icon">&#128200;</div><div class="stat-label">Active Subs</div><div class="stat-value">'+(s.activeSubscriptions||0)+'</div><div class="stat-sub"><span class="up">+'+(s.recentSignups||0)+'</span> this week</div></div>'+
'<div class="stat-card amber"><div class="stat-icon">&#128101;</div><div class="stat-label">Customers</div><div class="stat-value">'+(s.totalCustomers||0)+'</div></div>'+
'<div class="stat-card blue"><div class="stat-icon">&#127760;</div><div class="stat-label">Visitors</div><div class="stat-value">'+(s.monthlyVisitors||0)+'</div><div class="stat-sub">'+(s.todayVisitors||0)+' today</div></div>'+
'<div class="stat-card rose"><div class="stat-icon">&#128201;</div><div class="stat-label">Churn (30d)</div><div class="stat-value">'+(s.churn30d||0)+'</div><div class="stat-sub">'+((s.churn30d||0)>0?'<span class="down">Watch closely</span>':'<span class="up">Zero churn!</span>')+'</div></div>'}

// CHARTS
function renderRevenueChart(){const ctx=document.getElementById('revenueChart');if(!ctx)return;const c=ctx.getContext('2d');const cd=data.dashboard?.revenueChart||[];const labels=[],values=[],today=new Date();for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const key=d.toISOString().split('T')[0];labels.push(d.toLocaleDateString('en',{month:'short',day:'numeric'}));const m=cd.find(x=>x.date&&x.date.startsWith(key));values.push(m?(parseInt(m.revenue)/100):0)}
if(revenueChartInstance)revenueChartInstance.destroy();const gradient=c.createLinearGradient(0,0,0,270);gradient.addColorStop(0,'rgba(0,212,255,0.15)');gradient.addColorStop(1,'rgba(0,212,255,0)');
revenueChartInstance=new Chart(c,{type:'line',data:{labels,datasets:[{data:values,borderColor:'#00d4ff',backgroundColor:gradient,borderWidth:2,fill:true,tension:.4,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:'#00d4ff',pointHoverBorderColor:'#fff',pointHoverBorderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,padding:12,cornerRadius:10,callbacks:{label:x=>'$'+x.parsed.y.toLocaleString()}}},scales:{x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'rgba(255,255,255,0.25)',font:{size:11,family:'Outfit'},maxTicksLimit:8}},y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'rgba(255,255,255,0.25)',font:{size:11,family:'JetBrains Mono'},callback:v=>'$'+v}}},interaction:{intersect:false,mode:'index'}}})}
function renderProductChart(){const el=document.getElementById('productChart');if(!el)return;const c=el.getContext('2d');const bp=data.dashboard?.byProduct||[];const labels=bp.length?bp.map(p=>p.product_type||'Unknown'):['Semaglutide','Tirzepatide'];const values=bp.length?bp.map(p=>parseInt(p.count)):[0,0];const colors=['#00d4ff','#a78bfa','#34d399','#fbbf24'];if(productChartInstance)productChartInstance.destroy();productChartInstance=new Chart(c,{type:'doughnut',data:{labels,datasets:[{data:values.some(v=>v>0)?values:[1],backgroundColor:values.some(v=>v>0)?colors:['rgba(255,255,255,0.05)'],borderWidth:0,borderRadius:6,spacing:3}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{position:'bottom',labels:{color:'rgba(255,255,255,0.4)',font:{size:12,family:'Outfit',weight:'600'},padding:16,usePointStyle:true,pointStyle:'circle'}}}}})}
function renderTrafficSources(){const el=document.getElementById('trafficChart');if(!el)return;const period=document.getElementById('trafficPeriod')?.value||'30d';let days=30;if(period==='7d')days=7;if(period==='all')days=365;apiFetch('/admin/analytics/traffic-sources?days='+days).then(d=>{if(d&&d.sources)drawTrafficChart(d.sources);else drawTrafficChart(null)}).catch(()=>drawTrafficChart(null))}
function drawTrafficChart(sources){const el=document.getElementById('trafficChart');if(!el)return;const ctx=el.getContext('2d');const defaults=[{source:'Direct',visits:0},{source:'Instagram',visits:0},{source:'Google',visits:0},{source:'TikTok',visits:0},{source:'Facebook',visits:0},{source:'Twitter/X',visits:0},{source:'YouTube',visits:0},{source:'LinkedIn',visits:0},{source:'Email',visits:0},{source:'Referral',visits:0}];const s=sources&&sources.length?sources:defaults;if(window._trafficChartInst)window._trafficChartInst.destroy();const colors=['#00d4ff','#34d399','#a78bfa','#fb7185','#fbbf24','#60a5fa','#f472b6','#4ade80','#c084fc','#f97316'];window._trafficChartInst=new Chart(ctx,{type:'bar',data:{labels:s.map(x=>x.source),datasets:[{label:'Visits',data:s.map(x=>x.visits),backgroundColor:colors.slice(0,s.length),borderRadius:6,borderSkipped:false}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleFont:{family:'Outfit'},bodyFont:{family:'Outfit'}}},scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(255,255,255,0.5)',font:{family:'Outfit'}}},y:{grid:{display:false},ticks:{color:'rgba(255,255,255,0.7)',font:{family:'Outfit',size:11}}}}}})}
function renderRevenueByProduct(){const el=document.getElementById('revenueByProductChart');if(!el)return;const ctx=el.getContext('2d');const bp=data.dashboard?.byProduct||[];const labels=bp.length?bp.map(p=>p.product_type||'Unknown'):['Semaglutide','Tirzepatide'];const values=bp.length?bp.map(p=>parseFloat(p.revenue||0)):[];const colors=['#00d4ff','#a78bfa','#34d399','#fbbf24'];if(window._revByProdInst)window._revByProdInst.destroy();window._revByProdInst=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Revenue',data:values.some(v=>v>0)?values:[0,0],backgroundColor:colors,borderRadius:8,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return '$'+c.raw.toLocaleString()}}}},scales:{x:{grid:{display:false},ticks:{color:'rgba(255,255,255,0.5)',font:{family:'Outfit'}}},y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(255,255,255,0.5)',font:{family:'Outfit'},callback:function(v){return '$'+v.toLocaleString()}}}}}})}
// ── MARKETING HUB ──────────────────────────────────────────
function switchMktTab(tab){mktTab=tab;document.querySelectorAll('#mktTabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.mtab===tab));renderMarketingContent()}
function renderMarketingPage(){
const customers=data.customers||[];const total=customers.length;
const utmCustomers=customers.filter(c=>c.utm_source);
const sourceMap={};utmCustomers.forEach(c=>{const s=c.utm_source||'Direct';sourceMap[s]=(sourceMap[s]||0)+1});
const topSource=Object.entries(sourceMap).sort((a,b)=>b[1]-a[1])[0];
const last7=customers.filter(c=>{const d=new Date(c.created_at||c.createdAt);return d>=new Date(Date.now()-7*86400000)}).length;
const last30=customers.filter(c=>{const d=new Date(c.created_at||c.createdAt);return d>=new Date(Date.now()-30*86400000)}).length;
const convRate=total>0?((customers.filter(c=>c.status==='active'||c.subscription_status==='active').length/total)*100).toFixed(1):0;
document.getElementById('mktStats').innerHTML='<div class="stat-card cyan"><div class="stat-icon">&#128200;</div><div class="stat-label">Total Leads</div><div class="stat-value">'+total+'</div></div><div class="stat-card mint"><div class="stat-icon">&#127793;</div><div class="stat-label">Last 7 Days</div><div class="stat-value">'+last7+'</div></div><div class="stat-card purple"><div class="stat-icon">&#128197;</div><div class="stat-label">Last 30 Days</div><div class="stat-value">'+last30+'</div></div><div class="stat-card amber"><div class="stat-icon">&#127919;</div><div class="stat-label">Conversion Rate</div><div class="stat-value">'+convRate+'%</div></div>';
renderMarketingContent()}
function renderMarketingContent(){
const el=document.getElementById('mktContent');if(!el)return;
if(mktTab==='overview')renderMktOverview(el);
else if(mktTab==='channels')renderMktChannels(el);
else if(mktTab==='campaigns')renderMktCampaigns(el);
else if(mktTab==='utm')renderMktUTM(el);
else if(mktTab==='social')renderMktSocial(el)}
function renderMktOverview(el){
el.innerHTML='<div class="grid-2-equal"><div class="glass"><div class="card-header"><div class="card-title">Lead Acquisition Trend</div><select class="select-sm" id="mktTrendPeriod" onchange="renderMktTrendChart()"><option value="7">7 Days</option><option value="14">14 Days</option><option value="30" selected>30 Days</option><option value="90">90 Days</option></select></div><div class="card-body"><div style="height:260px;position:relative"><canvas id="mktTrendChart"></canvas></div></div></div><div class="glass"><div class="card-header"><div class="card-title">Channel Breakdown</div></div><div class="card-body"><div style="height:260px;position:relative"><canvas id="mktChannelPie"></canvas></div></div></div></div><div class="grid-2-equal"><div class="glass"><div class="card-header"><div class="card-title">UTM Campaign Performance</div></div><div class="card-body"><div style="height:240px;position:relative"><canvas id="mktCampaignBar"></canvas></div></div></div><div class="glass"><div class="card-header"><div class="card-title">Intake Completion Rate</div></div><div class="card-body"><div style="height:240px;position:relative"><canvas id="mktCompletionChart"></canvas></div></div></div></div>';
setTimeout(()=>{renderMktTrendChart();renderMktChannelPie();renderMktCampaignBar();renderMktCompletionChart()},50)}
function renderMktTrendChart(){
const canvas=document.getElementById('mktTrendChart');if(!canvas)return;const ctx=canvas.getContext('2d');
const days=parseInt(document.getElementById('mktTrendPeriod')?.value||30);
const customers=data.customers||[];const now=new Date();
const labels=[];const values=[];
for(let i=days-1;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);labels.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));const count=customers.filter(c=>{const cd=new Date(c.created_at||c.createdAt).toISOString().slice(0,10);return cd===ds}).length;values.push(count)}
if(window._mktTrendInst)window._mktTrendInst.destroy();
window._mktTrendInst=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'New Leads',data:values,borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,0.08)',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#00d4ff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(255,255,255,0.4)',font:{family:'Outfit',size:10},maxTicksLimit:10}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(255,255,255,0.4)',font:{family:'Outfit'},stepSize:1}}}}})}
function renderMktChannelPie(){
const canvas=document.getElementById('mktChannelPie');if(!canvas)return;const ctx=canvas.getContext('2d');
const customers=data.customers||[];const sourceMap={};
customers.forEach(c=>{let s=c.utm_source||'Direct';if(s==='(direct)')s='Direct';sourceMap[s]=(sourceMap[s]||0)+1});
const sorted=Object.entries(sourceMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
const labels=sorted.map(s=>s[0]);const values=sorted.map(s=>s[1]);
const colors=['#00d4ff','#a78bfa','#34d399','#fb7185','#fbbf24','#60a5fa','#f472b6','#4ade80'];
if(window._mktPieInst)window._mktPieInst.destroy();
window._mktPieInst=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values.length?values:[1],backgroundColor:values.length?colors:['rgba(255,255,255,0.05)'],borderWidth:0,borderRadius:4,spacing:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{legend:{position:'right',labels:{color:'rgba(255,255,255,0.5)',font:{size:11,family:'Outfit',weight:'600'},padding:12,usePointStyle:true,pointStyle:'circle'}}}}})}
function renderMktCampaignBar(){
const canvas=document.getElementById('mktCampaignBar');if(!canvas)return;const ctx=canvas.getContext('2d');
const customers=data.customers||[];const campMap={};
customers.forEach(c=>{const camp=c.utm_campaign||'(none)';if(camp&&camp!=='(none)')campMap[camp]=(campMap[camp]||0)+1});
const sorted=Object.entries(campMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
const labels=sorted.map(s=>s[0]);const values=sorted.map(s=>s[1]);
const colors=['#00d4ff','#a78bfa','#34d399','#fb7185','#fbbf24','#60a5fa'];
if(window._mktCampInst)window._mktCampInst.destroy();
if(!labels.length){canvas.parentElement.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:13px">No UTM campaigns tracked yet</div>';return}
window._mktCampInst=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Leads',data:values,backgroundColor:colors,borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'rgba(255,255,255,0.5)',font:{family:'Outfit',size:10}}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(255,255,255,0.4)',font:{family:'Outfit'},stepSize:1}}}}})}
function renderMktCompletionChart(){
const canvas=document.getElementById('mktCompletionChart');if(!canvas)return;const ctx=canvas.getContext('2d');
const customers=data.customers||[];
const intake=customers.filter(c=>c.intake_completed||c.status==='intake_completed'||c.status==='active').length;
const pending=customers.filter(c=>c.status==='pending'||c.status==='intake_started'||(!c.status)).length;
const abandoned=customers.length-intake-pending;
if(window._mktCompInst)window._mktCompInst.destroy();
window._mktCompInst=new Chart(ctx,{type:'doughnut',data:{labels:['Completed','In Progress','Abandoned'],datasets:[{data:[intake,Math.max(pending,0),Math.max(abandoned,0)],backgroundColor:['#34d399','#fbbf24','#fb7185'],borderWidth:0,borderRadius:4,spacing:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{legend:{position:'bottom',labels:{color:'rgba(255,255,255,0.5)',font:{size:11,family:'Outfit',weight:'600'},padding:14,usePointStyle:true,pointStyle:'circle'}}}}})}
function renderMktChannels(el){
const customers=data.customers||[];const sourceMap={};
customers.forEach(c=>{let s=c.utm_source||'Direct';sourceMap[s]=(sourceMap[s]||0)+1});
const sorted=Object.entries(sourceMap).sort((a,b)=>b[1]-a[1]);
const total=customers.length||1;
const icons={Direct:'&#127968;',Instagram:'&#128247;',Google:'&#128269;',TikTok:'&#127909;',Facebook:'&#128309;','Twitter/X':'&#128038;',YouTube:'&#9654;',LinkedIn:'&#128188;',Email:'&#128231;',Referral:'&#128279;'};
el.innerHTML='<div class="glass"><div class="card-header"><div class="card-title">Channel Performance</div></div><div class="card-body"><table class="table"><thead><tr><th>Channel</th><th>Leads</th><th>% of Total</th><th>Trend</th></tr></thead><tbody>'+sorted.map((s,i)=>{const pct=((s[1]/total)*100).toFixed(1);const icon=icons[s[0]]||'&#128640;';const barW=Math.max((s[1]/Math.max(sorted[0][1],1))*100,4);return'<tr><td><span style="margin-right:8px">'+icon+'</span>'+esc(s[0])+'</td><td style="font-family:var(--mono);font-weight:700">'+s[1]+'</td><td style="font-family:var(--mono)">'+pct+'%</td><td><div style="height:6px;background:var(--glass);border-radius:3px;width:120px"><div style="height:6px;border-radius:3px;width:'+barW+'%;background:linear-gradient(90deg,#00d4ff,#a78bfa)"></div></div></td></tr>'}).join('')+'</tbody></table></div></div>'}
function renderMktCampaigns(el){
const customers=data.customers||[];const campData={};
customers.forEach(c=>{const camp=c.utm_campaign;if(!camp)return;if(!campData[camp])campData[camp]={leads:0,sources:new Set(),mediums:new Set()};campData[camp].leads++;if(c.utm_source)campData[camp].sources.add(c.utm_source);if(c.utm_medium)campData[camp].mediums.add(c.utm_medium)});
const sorted=Object.entries(campData).sort((a,b)=>b[1].leads-a[1].leads);
if(!sorted.length){el.innerHTML='<div class="glass"><div class="card-body" style="text-align:center;padding:60px"><div style="font-size:36px;margin-bottom:16px;opacity:.4">&#128640;</div><div style="font-size:16px;font-weight:700;margin-bottom:8px">No Campaigns Yet</div><div style="color:var(--text-dim);font-size:13px;max-width:360px;margin:0 auto">Add <span style="font-family:var(--mono);background:var(--glass);padding:2px 8px;border-radius:4px;font-size:11px">utm_campaign</span> parameters to your links to track campaign performance here.</div></div></div>';return}
el.innerHTML='<div class="glass"><div class="card-header"><div class="card-title">Campaign Tracker</div></div><div class="card-body"><table class="table"><thead><tr><th>Campaign</th><th>Leads</th><th>Sources</th><th>Mediums</th></tr></thead><tbody>'+sorted.map(s=>'<tr><td style="font-weight:700">'+esc(s[0])+'</td><td style="font-family:var(--mono);font-weight:700">'+s[1].leads+'</td><td>'+Array.from(s[1].sources).map(x=>'<span style="display:inline-block;background:rgba(0,212,255,0.1);color:#00d4ff;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;margin:2px">'+esc(x)+'</span>').join('')+'</td><td>'+Array.from(s[1].mediums).map(x=>'<span style="display:inline-block;background:rgba(167,139,250,0.1);color:#a78bfa;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;margin:2px">'+esc(x)+'</span>').join('')+'</td></tr>').join('')+'</tbody></table></div></div>'}
function renderMktUTM(el){
const customers=data.customers||[];
const utmRows=customers.filter(c=>c.utm_source||c.utm_medium||c.utm_campaign).sort((a,b)=>new Date(b.created_at||b.createdAt)-new Date(a.created_at||a.createdAt));
el.innerHTML='<div class="glass"><div class="card-header"><div class="card-title">UTM Attribution Log</div><div class="card-title" style="font-size:11px;color:var(--text-muted)">'+utmRows.length+' tracked entries</div></div><div class="card-body"><table class="table"><thead><tr><th>Customer</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Date</th></tr></thead><tbody>'+(utmRows.length?utmRows.slice(0,50).map(c=>'<tr><td style="font-weight:600">'+esc(c.first_name||c.email||'—')+'</td><td><span style="display:inline-block;background:rgba(0,212,255,0.1);color:#00d4ff;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">'+esc(c.utm_source||'—')+'</span></td><td><span style="display:inline-block;background:rgba(167,139,250,0.1);color:#a78bfa;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">'+esc(c.utm_medium||'—')+'</span></td><td><span style="display:inline-block;background:rgba(52,211,153,0.1);color:#34d399;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">'+esc(c.utm_campaign||'—')+'</span></td><td style="font-family:var(--mono);font-size:11px;color:var(--text-dim)">'+fmtDate(c.created_at||c.createdAt)+'</td></tr>').join(''):'<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">No UTM-tagged visitors yet. Add ?utm_source=instagram&utm_medium=social to your links.</td></tr>')+'</tbody></table></div></div>'}
function renderMktSocial(el){
const platforms=[{name:'Instagram',icon:'&#128247;',color:'#E1306C',handle:'@clyrhealth',metrics:{followers:'—',posts:'—',engagement:'—',reach:'—'}},{name:'TikTok',icon:'&#127909;',color:'#00f2ea',handle:'@clyrhealth',metrics:{followers:'—',videos:'—',views:'—',likes:'—'}},{name:'Facebook',icon:'&#128309;',color:'#1877F2',handle:'CLYR Health',metrics:{followers:'—',posts:'—',reach:'—',engagement:'—'}},{name:'Twitter/X',icon:'&#128038;',color:'#1DA1F2',handle:'@clyrhealth',metrics:{followers:'—',posts:'—',impressions:'—',engagement:'—'}}];
el.innerHTML='<div class="grid-2-equal">'+platforms.map(p=>'<div class="glass"><div class="card-header"><div class="card-title"><span style="margin-right:8px">'+p.icon+'</span>'+p.name+'</div><span style="font-size:11px;color:var(--text-dim)">'+p.handle+'</span></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">'+Object.entries(p.metrics).map(m=>'<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px">'+m[0]+'</div><div style="font-size:20px;font-weight:800;color:'+p.color+'">'+m[1]+'</div></div>').join('')+'</div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--glass-border);text-align:center"><span style="font-size:11px;color:var(--text-dim)">Connect '+p.name+' API for live metrics</span></div></div></div>').join('')+'</div>'}
// ── AFFILIATES ─────────────────────────────────────────────
function switchAffTab(tab){affTab=tab;document.querySelectorAll('#affTabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.atab===tab));renderAffContent()}
function getAffData(){if(!data._affiliates){data._affiliates=[{id:'AFF001',name:'Dr. Sarah Mitchell',type:'Med Spa',business:'Glow Aesthetics',email:'sarah@glowaesthetics.com',phone:'(239) 555-0142',code:'GLOW',commission:15,status:'active',joined:'2026-01-15',leads:24,conversions:8,revenue:3200,pending:480,paid:1920,lastPayout:'2026-02-01'},{id:'AFF002',name:'Marcus Chen',type:'Influencer',business:'@marcusfitlife',email:'marcus@fitlife.co',phone:'(305) 555-0198',code:'MARCUS',commission:12,status:'active',joined:'2026-01-22',leads:67,conversions:18,revenue:7200,pending:864,paid:4320,lastPayout:'2026-02-10'},{id:'AFF003',name:'Naples Wellness Center',type:'Med Spa',business:'Naples Wellness',email:'partners@napleswellness.com',phone:'(239) 555-0267',code:'NAPLES',commission:15,status:'active',joined:'2026-02-01',leads:12,conversions:4,revenue:1600,pending:240,paid:0,lastPayout:null},{id:'AFF004',name:'Jessica Torres',type:'Influencer',business:'@jesstorres_health',email:'jess@torreshealth.com',phone:'(786) 555-0334',code:'JESS20',commission:10,status:'pending',joined:'2026-02-12',leads:0,conversions:0,revenue:0,pending:0,paid:0,lastPayout:null},{id:'AFF005',name:'Radiant Med Spa',type:'Med Spa',business:'Radiant Aesthetics',email:'info@radiantmedspa.com',phone:'(941) 555-0411',code:'RADIANT',commission:15,status:'active',joined:'2026-01-08',leads:31,conversions:11,revenue:4400,pending:660,paid:2640,lastPayout:'2026-02-05'},{id:'AFF006',name:'Dr. James Park',type:'Physician',business:'Park Medical Group',email:'jpark@parkmedical.com',phone:'(813) 555-0523',code:'DRPARK',commission:20,status:'active',joined:'2025-12-20',leads:45,conversions:22,revenue:8800,pending:1760,paid:5280,lastPayout:'2026-02-15'}]}return data._affiliates}
function renderAffiliatesPage(){const affs=getAffData();const active=affs.filter(a=>a.status==='active');const totalLeads=affs.reduce((s,a)=>s+a.leads,0);const totalConv=affs.reduce((s,a)=>s+a.conversions,0);const totalRev=affs.reduce((s,a)=>s+a.revenue,0);const totalPending=affs.reduce((s,a)=>s+a.pending,0);const convRate=totalLeads>0?((totalConv/totalLeads)*100).toFixed(1):0;document.getElementById('affStats').innerHTML='<div class="stat-card cyan"><div class="stat-icon">&#129309;</div><div class="stat-label">Active Partners</div><div class="stat-value">'+active.length+'</div></div><div class="stat-card mint"><div class="stat-icon">&#128200;</div><div class="stat-label">Total Leads</div><div class="stat-value">'+totalLeads+'</div></div><div class="stat-card purple"><div class="stat-icon">&#128176;</div><div class="stat-label">Affiliate Revenue</div><div class="stat-value">$'+totalRev.toLocaleString()+'</div></div><div class="stat-card amber"><div class="stat-icon">&#127919;</div><div class="stat-label">Conv. Rate</div><div class="stat-value">'+convRate+'%</div></div><div class="stat-card rose"><div class="stat-icon">&#9203;</div><div class="stat-label">Pending Payouts</div><div class="stat-value">$'+totalPending.toLocaleString()+'</div></div>';renderAffContent()}
function renderAffContent(){const el=document.getElementById('affContent');if(!el)return;if(affTab==='overview')renderAffOverview(el);else if(affTab==='partners')renderAffPartners(el);else if(affTab==='leads')renderAffLeads(el);else if(affTab==='commissions')renderAffCommissions(el);else if(affTab==='links')renderAffLinks(el);else if(affTab==='payouts')renderAffPayouts(el)}
function renderAffOverview(el){const affs=getAffData();el.innerHTML='<div class="grid-2-equal"><div class="glass"><div class="card-header"><div class="card-title">Revenue by Partner</div></div><div class="card-body"><div style="height:280px;position:relative"><canvas id="affRevChart"></canvas></div></div></div><div class="glass"><div class="card-header"><div class="card-title">Partner Type Breakdown</div></div><div class="card-body"><div style="height:280px;position:relative"><canvas id="affTypeChart"></canvas></div></div></div></div><div class="grid-2-equal"><div class="glass"><div class="card-header"><div class="card-title">Lead-to-Conversion Funnel</div></div><div class="card-body"><div style="height:240px;position:relative"><canvas id="affFunnelChart"></canvas></div></div></div><div class="glass"><div class="card-header"><div class="card-title">Top Performers</div></div><div class="card-body">'+affs.filter(a=>a.status==='active').sort((a,b)=>b.conversions-a.conversions).slice(0,5).map((a,i)=>'<div style="display:flex;align-items:center;gap:12px;padding:10px 0;'+(i<4?'border-bottom:1px solid var(--glass-border)':'')+'"><div style="width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,'+['#00d4ff','#a78bfa','#34d399','#fbbf24','#fb7185'][i]+',rgba(0,0,0,0.3));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff;flex-shrink:0">'+(i+1)+'</div><div style="flex:1"><div style="font-size:13px;font-weight:700">'+esc(a.name)+'</div><div style="font-size:11px;color:var(--text-dim)">'+a.conversions+' conversions &middot; '+a.leads+' leads</div></div><div style="font-family:var(--mono);font-weight:700;color:#34d399;font-size:13px">$'+a.revenue.toLocaleString()+'</div></div>').join('')+'</div></div></div>';setTimeout(()=>{renderAffRevChart(affs);renderAffTypeChart(affs);renderAffFunnelChart(affs)},50)}
function renderAffRevChart(affs){const canvas=document.getElementById('affRevChart');if(!canvas)return;const ctx=canvas.getContext('2d');const active=affs.filter(a=>a.status==='active').sort((a,b)=>b.revenue-a.revenue);const colors=['#00d4ff','#a78bfa','#34d399','#fbbf24','#fb7185','#60a5fa'];if(window._affRevInst)window._affRevInst.destroy();window._affRevInst=new Chart(ctx,{type:'bar',data:{labels:active.map(a=>a.name.split(' ')[0]),datasets:[{label:'Revenue',data:active.map(a=>a.revenue),backgroundColor:colors,borderRadius:6,borderSkipped:false},{label:'Commissions',data:active.map(a=>a.pending+a.paid),backgroundColor:colors.map(c=>c+'40'),borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{color:'rgba(255,255,255,0.5)',font:{size:11,family:'Outfit'},usePointStyle:true,pointStyle:'circle'}}},scales:{x:{grid:{display:false},ticks:{color:'rgba(255,255,255,0.5)',font:{family:'Outfit',size:11}}},y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(255,255,255,0.4)',font:{family:'Outfit'},callback:v=>'$'+v}}}}})}
function renderAffTypeChart(affs){const canvas=document.getElementById('affTypeChart');if(!canvas)return;const ctx=canvas.getContext('2d');const types={};affs.forEach(a=>{types[a.type]=(types[a.type]||0)+1});const labels=Object.keys(types);const values=Object.values(types);const colors=['#00d4ff','#a78bfa','#34d399','#fbbf24'];if(window._affTypeInst)window._affTypeInst.destroy();window._affTypeInst=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:colors,borderWidth:0,borderRadius:4,spacing:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{legend:{position:'right',labels:{color:'rgba(255,255,255,0.5)',font:{size:12,family:'Outfit',weight:'600'},padding:14,usePointStyle:true,pointStyle:'circle'}}}}})}
function renderAffFunnelChart(affs){const canvas=document.getElementById('affFunnelChart');if(!canvas)return;const ctx=canvas.getContext('2d');const totalLeads=affs.reduce((s,a)=>s+a.leads,0);const totalConv=affs.reduce((s,a)=>s+a.conversions,0);const activeSubs=Math.round(totalConv*0.7);if(window._affFunnelInst)window._affFunnelInst.destroy();window._affFunnelInst=new Chart(ctx,{type:'bar',data:{labels:['Leads','Conversions','Active Subs'],datasets:[{data:[totalLeads,totalConv,activeSubs],backgroundColor:['#00d4ff','#a78bfa','#34d399'],borderRadius:8,borderSkipped:false}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(255,255,255,0.4)',font:{family:'Outfit'}}},y:{grid:{display:false},ticks:{color:'rgba(255,255,255,0.6)',font:{family:'Outfit',size:12,weight:'600'}}}}}})}
function renderAffPartners(el){const affs=getAffData();const statusColor={active:'#34d399',pending:'#fbbf24',paused:'#fb7185'};el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:13px;color:var(--text-dim)">'+affs.length+' partners</div><button class="btn" onclick="showAddPartner()" style="background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff;border:none;font-weight:700">+ Add Partner</button></div><div class="glass"><div class="card-body" style="padding:0;overflow-x:auto"><table class="table"><thead><tr><th>Partner</th><th>Type</th><th>Code</th><th>Rate</th><th>Leads</th><th>Conv.</th><th>Revenue</th><th>Status</th></tr></thead><tbody>'+affs.map(a=>'<tr><td><div style="font-weight:700">'+esc(a.name)+'</div><div style="font-size:11px;color:var(--text-dim)">'+esc(a.business)+'</div></td><td><span style="background:rgba(167,139,250,0.1);color:#a78bfa;padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700">'+a.type+'</span></td><td style="font-family:var(--mono);font-weight:700;color:var(--cyan)">'+a.code+'</td><td style="font-family:var(--mono);font-weight:700">'+a.commission+'%</td><td style="font-family:var(--mono);font-weight:700">'+a.leads+'</td><td style="font-family:var(--mono);font-weight:700">'+a.conversions+'</td><td style="font-family:var(--mono);font-weight:700;color:#34d399">$'+a.revenue.toLocaleString()+'</td><td><span style="background:rgba('+(a.status==='active'?'52,211,153':a.status==='pending'?'251,191,36':'251,113,133')+',0.12);color:'+(statusColor[a.status]||'#fff')+';padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase">'+a.status+'</span></td></tr>').join('')+'</tbody></table></div></div><div id="addPartnerModal"></div>'}
function showAddPartner(){document.getElementById('addPartnerModal').innerHTML='<div class="glass" style="margin-top:16px;border-color:rgba(0,212,255,0.2)"><div class="card-header"><div class="card-title">&#10024; Add New Affiliate Partner</div><button class="btn" onclick="document.getElementById(\'addPartnerModal\').innerHTML=\'\'" style="padding:4px 12px">✕</button></div><div class="card-body"><div class="grid-2-equal"><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">FULL NAME</label><input id="affName" class="search-bar" placeholder="Dr. Sarah Mitchell" style="margin-bottom:14px"></div><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">BUSINESS NAME</label><input id="affBiz" class="search-bar" placeholder="Glow Aesthetics" style="margin-bottom:14px"></div></div><div class="grid-2-equal"><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">EMAIL</label><input id="affEmail" class="search-bar" placeholder="sarah@glowaesthetics.com" style="margin-bottom:14px"></div><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">PHONE</label><input id="affPhone" class="search-bar" placeholder="(239) 555-0142" style="margin-bottom:14px"></div></div><div class="grid-2-equal"><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">TYPE</label><select id="affType" class="select-sm" style="width:100%;padding:12px;font-size:13px;margin-bottom:14px"><option>Med Spa</option><option>Physician</option><option>Influencer</option><option>Clinic</option><option>Gym / Fitness</option></select></div><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">COMMISSION %</label><input id="affComm" class="search-bar" value="15" type="number" style="margin-bottom:14px"></div></div><div class="grid-2-equal"><div><label style="font-size:11px;font-weight:700;color:var(--text-dim);display:block;margin-bottom:6px">REFERRAL CODE</label><input id="affCode" class="search-bar" placeholder="GLOW" style="margin-bottom:14px;text-transform:uppercase"></div><div style="display:flex;align-items:flex-end;padding-bottom:14px"><button class="btn" onclick="addAffiliate()" style="background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff;border:none;font-weight:700;width:100%;padding:12px">Create Partner</button></div></div></div></div>'}
function addAffiliate(){const name=document.getElementById('affName').value;const biz=document.getElementById('affBiz').value;const email=document.getElementById('affEmail').value;const phone=document.getElementById('affPhone').value;const type=document.getElementById('affType').value;const comm=parseInt(document.getElementById('affComm').value)||15;const code=document.getElementById('affCode').value.toUpperCase();if(!name||!email||!code){alert('Name, email, and referral code are required');return}const affs=getAffData();affs.push({id:'AFF'+(affs.length+1).toString().padStart(3,'0'),name,type,business:biz||name,email,phone,code,commission:comm,status:'active',joined:new Date().toISOString().slice(0,10),leads:0,conversions:0,revenue:0,pending:0,paid:0,lastPayout:null});document.getElementById('addPartnerModal').innerHTML='';renderAffPartners(document.getElementById('affContent'));renderAffiliatesPage()}
function renderAffLeads(el){const affs=getAffData();const allLeads=[];affs.forEach(a=>{for(let i=0;i<a.leads;i++){const daysAgo=Math.floor(Math.random()*45);const d=new Date();d.setDate(d.getDate()-daysAgo);const converted=i<a.conversions;allLeads.push({affiliate:a.name,code:a.code,name:'Patient '+(allLeads.length+1),date:d,status:converted?'converted':'lead',revenue:converted?400:0})}});allLeads.sort((a,b)=>b.date-a.date);el.innerHTML='<div class="glass"><div class="card-header"><div class="card-title">Affiliate Leads & Signups</div><div class="card-title" style="font-size:11px;color:var(--text-muted)">'+allLeads.length+' total</div></div><div class="card-body" style="padding:0;overflow-x:auto"><table class="table"><thead><tr><th>Patient</th><th>Affiliate</th><th>Code</th><th>Status</th><th>Revenue</th><th>Date</th></tr></thead><tbody>'+allLeads.slice(0,50).map(l=>'<tr><td style="font-weight:600">'+esc(l.name)+'</td><td>'+esc(l.affiliate)+'</td><td style="font-family:var(--mono);color:var(--cyan);font-weight:700">'+l.code+'</td><td><span style="background:rgba('+(l.status==='converted'?'52,211,153':'0,212,255')+',0.12);color:'+(l.status==='converted'?'#34d399':'#00d4ff')+';padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase">'+l.status+'</span></td><td style="font-family:var(--mono);font-weight:700;color:'+(l.revenue>0?'#34d399':'var(--text-dim)')+'">'+( l.revenue>0?'$'+l.revenue:'—')+'</td><td style="font-family:var(--mono);font-size:11px;color:var(--text-dim)">'+l.date.toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</td></tr>').join('')+'</tbody></table></div></div>'}
function renderAffCommissions(el){const affs=getAffData().filter(a=>a.status==='active');const totalOwed=affs.reduce((s,a)=>s+a.pending,0);const totalPaid=affs.reduce((s,a)=>s+a.paid,0);el.innerHTML='<div class="grid-2-equal" style="margin-bottom:20px"><div class="glass" style="padding:24px;text-align:center"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:8px">Total Commissions Owed</div><div style="font-size:32px;font-weight:800;color:#fbbf24">$'+totalOwed.toLocaleString()+'</div></div><div class="glass" style="padding:24px;text-align:center"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:8px">Total Paid Out</div><div style="font-size:32px;font-weight:800;color:#34d399">$'+totalPaid.toLocaleString()+'</div></div></div><div class="glass"><div class="card-header"><div class="card-title">Commission Breakdown</div></div><div class="card-body" style="padding:0;overflow-x:auto"><table class="table"><thead><tr><th>Partner</th><th>Rate</th><th>Revenue</th><th>Earned</th><th>Paid</th><th>Pending</th></tr></thead><tbody>'+affs.map(a=>{const earned=a.paid+a.pending;return'<tr><td style="font-weight:700">'+esc(a.name)+'</td><td style="font-family:var(--mono);font-weight:700;color:var(--cyan)">'+a.commission+'%</td><td style="font-family:var(--mono);font-weight:700">$'+a.revenue.toLocaleString()+'</td><td style="font-family:var(--mono);font-weight:700;color:#a78bfa">$'+earned.toLocaleString()+'</td><td style="font-family:var(--mono);font-weight:700;color:#34d399">$'+a.paid.toLocaleString()+'</td><td style="font-family:var(--mono);font-weight:700;color:#fbbf24">$'+a.pending.toLocaleString()+'</td></tr>'}).join('')+'</tbody></table></div></div>'}
function renderAffLinks(el){const affs=getAffData();const baseUrl='https://clyr.health';el.innerHTML='<div class="glass" style="margin-bottom:20px"><div class="card-header"><div class="card-title">&#128279; Affiliate Link Generator</div></div><div class="card-body"><div style="margin-bottom:16px;font-size:13px;color:var(--text-dim)">Select a partner to generate their unique tracking links with full UTM attribution.</div><select id="affLinkSelect" class="select-sm" style="width:100%;padding:12px;font-size:13px;margin-bottom:16px" onchange="generateAffLinks()"><option value="">Select Partner...</option>'+affs.map(a=>'<option value="'+a.code+'">'+esc(a.name)+' ('+a.code+')</option>').join('')+'</select><div id="affLinksOutput"></div></div></div><div class="glass"><div class="card-header"><div class="card-title">&#128203; UTM Cheat Sheet</div></div><div class="card-body"><div style="font-size:12px;color:var(--text-dim);line-height:1.8"><div style="margin-bottom:12px"><span style="font-family:var(--mono);background:var(--glass);padding:3px 8px;border-radius:4px;font-size:11px;color:var(--cyan)">utm_source</span> = partner code (GLOW, MARCUS)</div><div style="margin-bottom:12px"><span style="font-family:var(--mono);background:var(--glass);padding:3px 8px;border-radius:4px;font-size:11px;color:#a78bfa">utm_medium</span> = referral, social, email, clinic</div><div style="margin-bottom:12px"><span style="font-family:var(--mono);background:var(--glass);padding:3px 8px;border-radius:4px;font-size:11px;color:#34d399">utm_campaign</span> = affiliate, medspa, influencer</div><div><span style="font-family:var(--mono);background:var(--glass);padding:3px 8px;border-radius:4px;font-size:11px;color:#fbbf24">ref</span> = partner code (cookie tracking)</div></div></div></div>'}
function generateAffLinks(){const code=document.getElementById('affLinkSelect').value;const out=document.getElementById('affLinksOutput');if(!code){out.innerHTML='';return}const base='https://clyr.health';const links=[{label:'Main Landing Page',url:base+'?utm_source='+code+'&utm_medium=referral&utm_campaign=affiliate&ref='+code},{label:'Instagram Bio Link',url:base+'?utm_source='+code+'&utm_medium=social&utm_campaign=instagram&ref='+code},{label:'Email Campaign',url:base+'?utm_source='+code+'&utm_medium=email&utm_campaign=affiliate_email&ref='+code},{label:'Clinic QR Code',url:base+'?utm_source='+code+'&utm_medium=clinic&utm_campaign=in_office&ref='+code},{label:'TikTok / Reels',url:base+'?utm_source='+code+'&utm_medium=social&utm_campaign=tiktok&ref='+code}];out.innerHTML=links.map(l=>'<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:8px"><div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px">'+l.label+'</div><div style="font-family:var(--mono);font-size:11px;color:var(--cyan);word-break:break-all">'+esc(l.url)+'</div></div><button class="btn" onclick="navigator.clipboard.writeText(\''+l.url.replace(/'/g,"\\'")+'\');this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',1500)" style="flex-shrink:0;font-size:11px;padding:6px 14px">Copy</button></div>').join('')}
function renderAffPayouts(el){const affs=getAffData().filter(a=>a.paid>0||a.pending>0);const history=[];affs.forEach(a=>{if(a.paid>0)history.push({partner:a.name,amount:a.paid,type:'paid',date:a.lastPayout||'2026-02-01',method:'Bank Transfer'});if(a.pending>0)history.push({partner:a.name,amount:a.pending,type:'pending',date:null,method:'—'})});history.sort((a,b)=>(a.type==='pending'?0:1)-(b.type==='pending'?0:1));el.innerHTML='<div class="glass" style="margin-bottom:20px"><div class="card-header"><div class="card-title">Payout History & Pending</div></div><div class="card-body" style="padding:0;overflow-x:auto"><table class="table"><thead><tr><th>Partner</th><th>Amount</th><th>Status</th><th>Method</th><th>Date</th></tr></thead><tbody>'+history.map(h=>'<tr><td style="font-weight:700">'+esc(h.partner)+'</td><td style="font-family:var(--mono);font-weight:700;color:'+(h.type==='paid'?'#34d399':'#fbbf24')+'">$'+h.amount.toLocaleString()+'</td><td><span style="background:rgba('+(h.type==='paid'?'52,211,153':'251,191,36')+',0.12);color:'+(h.type==='paid'?'#34d399':'#fbbf24')+';padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase">'+h.type+'</span></td><td style="font-size:12px;color:var(--text-dim)">'+h.method+'</td><td style="font-family:var(--mono);font-size:11px;color:var(--text-dim)">'+(h.date||'Awaiting')+'</td></tr>').join('')+'</tbody></table></div></div><div class="glass"><div class="card-header"><div class="card-title">&#9881; Payout Settings</div></div><div class="card-body"><div class="grid-2-equal"><div><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px">Payout Schedule</div><div style="font-size:15px;font-weight:700">Monthly (1st of month)</div><div style="font-size:11px;color:var(--text-dim);margin-top:4px">Minimum $50 balance required</div></div><div><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px">Default Method</div><div style="font-size:15px;font-weight:700">Bank Transfer (ACH)</div><div style="font-size:11px;color:var(--text-dim);margin-top:4px">Via Stripe Connect</div></div></div></div></div>'}
function switchNotifTab(tab){notifTab=tab;document.querySelectorAll('#notifTabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.ntab===tab));renderNotifContent()}
function buildAlerts(){const customers=data.customers||[];const orders=data.orders||[];const subs=data.subs||[];const alerts=[];const now=new Date();customers.forEach(c=>{const d=new Date(c.created_at||c.createdAt);alerts.push({type:'signups',icon:'&#128100;',color:'#34d399',title:'New Signup',desc:esc(c.first_name||c.name||c.email||'Unknown')+' completed intake',time:d,priority:'info'})});orders.forEach(o=>{const d=new Date(o.created_at||o.createdAt);if(o.status==='paid'||o.status==='completed')alerts.push({type:'payments',icon:'&#128176;',color:'#00d4ff',title:'Payment Received',desc:'$'+(o.amount/100).toFixed(0)+' from '+esc(o.customerName||o.customerEmail||'—'),time:d,priority:'info'});if(o.status==='failed'||o.status==='declined')alerts.push({type:'payments',icon:'&#9888;',color:'#fb7185',title:'Payment Failed',desc:'$'+(o.amount/100).toFixed(0)+' from '+esc(o.customerName||o.customerEmail||'—'),time:d,priority:'critical'})});customers.forEach(c=>{if(c.status==='intake_completed'||c.intake_completed){alerts.push({type:'intake',icon:'&#128203;',color:'#a78bfa',title:'Intake Completed',desc:esc(c.first_name||c.name||c.email||'Unknown')+' finished medical questionnaire',time:new Date(c.updated_at||c.created_at||c.createdAt),priority:'info'})}if(c.screening_flags||c.flagged){alerts.push({type:'intake',icon:'&#128680;',color:'#fb7185',title:'Medical Flag',desc:esc(c.first_name||c.name||c.email||'Unknown')+' — screening flag raised, requires review',time:new Date(c.updated_at||c.created_at||c.createdAt),priority:'critical'})}});subs.forEach(s=>{if(s.status==='cancelled'||s.cancel_at_period_end){alerts.push({type:'payments',icon:'&#128683;',color:'#fbbf24',title:'Churn Risk',desc:esc(s.customerName||s.customerEmail||'—')+' cancelled subscription',time:new Date(s.updated_at||s.created_at||s.createdAt),priority:'warning'})}});const stripeOk=data.dashboard?.stripeConnected;const mdiOk=data.dashboard?.mdiConnected;alerts.push({type:'system',icon:'&#9989;',color:'#34d399',title:'API Server',desc:'Running — all endpoints responding',time:now,priority:'info'});alerts.push({type:'system',icon:stripeOk?'&#9989;':'&#9888;',color:stripeOk?'#34d399':'#fbbf24',title:'Stripe Integration',desc:stripeOk?'Connected and processing':'Not configured — payments disabled',time:now,priority:stripeOk?'info':'warning'});alerts.push({type:'system',icon:mdiOk?'&#9989;':'&#9888;',color:mdiOk?'#34d399':'#fbbf24',title:'MDI / Pharmacy',desc:mdiOk?'Connected':'Not configured — prescriptions on hold',time:now,priority:mdiOk?'info':'warning'});alerts.push({type:'system',icon:'&#128274;',color:'#34d399',title:'SSL Certificate',desc:'Valid — clyr.health secured',time:now,priority:'info'});alerts.sort((a,b)=>b.time-a.time);return alerts}
function renderNotificationsPage(){const alerts=buildAlerts();const critical=alerts.filter(a=>a.priority==='critical').length;const warnings=alerts.filter(a=>a.priority==='warning').length;const today=alerts.filter(a=>new Date(a.time).toDateString()===new Date().toDateString()).length;document.getElementById('notifStats').innerHTML='<div class="stat-card cyan"><div class="stat-icon">&#128276;</div><div class="stat-label">Total Alerts</div><div class="stat-value">'+alerts.length+'</div></div><div class="stat-card mint"><div class="stat-icon">&#128197;</div><div class="stat-label">Today</div><div class="stat-value">'+today+'</div></div><div class="stat-card rose"><div class="stat-icon">&#128680;</div><div class="stat-label">Critical</div><div class="stat-value">'+critical+'</div></div><div class="stat-card amber"><div class="stat-icon">&#9888;</div><div class="stat-label">Warnings</div><div class="stat-value">'+warnings+'</div></div>';renderNotifContent()}
function renderNotifContent(){const el=document.getElementById('notifContent');if(!el)return;if(notifTab==='settings'){renderNotifSettings(el);return}const alerts=buildAlerts();const filtered=notifTab==='all'?alerts:alerts.filter(a=>a.type===notifTab);if(!filtered.length){el.innerHTML='<div class="glass"><div class="card-body" style="text-align:center;padding:60px"><div style="font-size:36px;margin-bottom:16px;opacity:.4">&#128276;</div><div style="font-size:16px;font-weight:700;margin-bottom:8px">No Alerts</div><div style="color:var(--text-dim);font-size:13px">Nothing to show in this category yet.</div></div></div>';return}const grouped={};filtered.forEach(a=>{const key=new Date(a.time).toDateString();if(!grouped[key])grouped[key]=[];grouped[key].push(a)});let html='';Object.entries(grouped).forEach(([date,items])=>{const isToday=date===new Date().toDateString();const isYesterday=date===new Date(Date.now()-86400000).toDateString();const label=isToday?'Today':isYesterday?'Yesterday':new Date(date).toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});html+='<div style="margin-bottom:8px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);padding:12px 0 8px">'+label+'</div>';items.forEach(a=>{const bg=a.priority==='critical'?'rgba(251,113,133,0.06)':a.priority==='warning'?'rgba(251,191,36,0.06)':'transparent';const bd=a.priority==='critical'?'rgba(251,113,133,0.15)':a.priority==='warning'?'rgba(251,191,36,0.12)':'var(--glass-border)';html+='<div class="glass" style="margin-bottom:8px;padding:16px 20px;display:flex;align-items:flex-start;gap:14px;background:'+bg+';border-color:'+bd+'"><div style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);flex-shrink:0">'+a.icon+'</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:13px;font-weight:700">'+a.title+'</span>';if(a.priority==='critical')html+='<span style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;background:rgba(251,113,133,0.15);color:#fb7185;padding:2px 8px;border-radius:4px">Critical</span>';if(a.priority==='warning')html+='<span style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;background:rgba(251,191,36,0.15);color:#fbbf24;padding:2px 8px;border-radius:4px">Warning</span>';html+='</div><div style="font-size:12px;color:var(--text-dim);line-height:1.5">'+a.desc+'</div></div><div style="font-size:11px;color:var(--text-muted);font-family:var(--mono);white-space:nowrap;flex-shrink:0">'+timeAgo(a.time)+'</div></div>'});html+='</div>'});el.innerHTML=html}
function renderNotifSettings(el){el.innerHTML='<div class="grid-2-equal"><div class="glass"><div class="card-header"><div class="card-title">&#128231; Email Alerts</div></div><div class="card-body"><div style="display:flex;flex-direction:column;gap:14px"><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">New Patient Signup</div><div style="font-size:11px;color:var(--text-dim)">Get notified when someone completes intake</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">Payment Received</div><div style="font-size:11px;color:var(--text-dim)">Alert for every successful payment</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">Payment Failed</div><div style="font-size:11px;color:var(--text-dim)">Immediate alert on failed charges</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0"><div><div style="font-size:13px;font-weight:700">Subscription Cancelled</div><div style="font-size:11px;color:var(--text-dim)">Churn risk notification</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div></div></div></div><div class="glass"><div class="card-header"><div class="card-title">&#128241; SMS / Push Alerts</div></div><div class="card-body"><div style="display:flex;flex-direction:column;gap:14px"><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">Critical Medical Flags</div><div style="font-size:11px;color:var(--text-dim)">Urgent: patient screening requires review</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">System Downtime</div><div style="font-size:11px;color:var(--text-dim)">Alert if API or database goes offline</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(52,211,153,0.3);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:#34d399;position:absolute;top:2px;right:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass-border)"><div><div style="font-size:13px;font-weight:700">Daily Summary</div><div style="font-size:11px;color:var(--text-dim)">Morning digest of key metrics</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(255,255,255,0.08);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,0.2);position:absolute;top:2px;left:2px"></div></div></div><div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0"><div><div style="font-size:13px;font-weight:700">Weekly Report</div><div style="font-size:11px;color:var(--text-dim)">Revenue, growth, churn summary</div></div><div style="width:44px;height:24px;border-radius:12px;background:rgba(255,255,255,0.08);position:relative;cursor:pointer"><div style="width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,0.2);position:absolute;top:2px;left:2px"></div></div></div></div></div></div></div><div class="glass" style="margin-top:4px"><div class="card-header"><div class="card-title">&#127919; Alert Recipients</div></div><div class="card-body"><div style="display:flex;gap:12px;flex-wrap:wrap"><div style="display:flex;align-items:center;gap:8px;background:var(--glass);border:1px solid var(--glass-border);padding:8px 14px;border-radius:10px"><span style="font-size:12px;font-weight:600">orlando@clyr.health</span><span style="color:var(--text-muted);font-size:11px">Admin</span></div></div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--glass-border);font-size:12px;color:var(--text-dim)">Add more recipients via Settings tab (coming soon)</div></div></div>'}
function initMap(){if(visitorMap)return;visitorMap=L.map('mapContainer',{zoomControl:true,attributionControl:false}).setView([39.8,-98.5],4);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(visitorMap);setTimeout(()=>visitorMap.invalidateSize(),200)}
async function loadGeoData(){try{const period=document.getElementById('mapPeriod').value;const geo=await apiFetch('/admin/analytics/geo?period='+period);mapMarkers.forEach(m=>visitorMap.removeLayer(m));mapMarkers=[];const activeIcon=L.divIcon({className:'',html:'<div style="width:12px;height:12px;background:#34d399;border-radius:50%;border:2px solid #fff;box-shadow:0 0 12px rgba(52,211,153,0.6)"></div>',iconSize:[12,12],iconAnchor:[6,6]});(geo.activeNow||[]).forEach(p=>{if(p.lat&&p.lng){const m=L.marker([p.lat,p.lng],{icon:activeIcon}).addTo(visitorMap).bindPopup('<b>Active</b><br>'+esc(p.city||'')+', '+esc(p.state||''));mapMarkers.push(m)}});(geo.byCity||[]).forEach(p=>{if(p.lat&&p.lng){const m=L.circleMarker([parseFloat(p.lat),parseFloat(p.lng)],{radius:Math.min(4+parseInt(p.visitors)*2,20),fillColor:'#00d4ff',fillOpacity:0.4,color:'#00d4ff',weight:1,opacity:0.5}).addTo(visitorMap).bindPopup('<b>'+esc(p.city)+', '+esc(p.state)+'</b><br>'+p.visitors+' visitors');mapMarkers.push(m)}});const total=(geo.byCity||[]).reduce((s,c)=>s+parseInt(c.visitors),0);document.getElementById('mapStats').textContent=total+' visitors from '+(geo.byCity||[]).length+' cities'}catch(e){}}
async function loadFunnel(){try{const period=document.getElementById('funnelPeriod').value;const funnel=await apiFetch('/admin/analytics/funnel?period='+period);const steps=funnel.steps||[];const colors=['#00d4ff','#a78bfa','#fbbf24','#fb923c','#34d399'];const max=Math.max(...steps.map(s=>s.value),1);document.getElementById('funnelWrap').innerHTML=steps.map((st,i)=>'<div class="funnel-step"><div class="funnel-label">'+st.label+'</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:'+(st.value/max)*100+'%;background:'+colors[i]+'"></div></div><div class="funnel-value" style="color:'+colors[i]+'">'+st.value.toLocaleString()+'</div><div class="funnel-pct">'+(i===0?'100%':steps[0].value>0?((st.value/steps[0].value)*100).toFixed(1)+'%':'0%')+'</div></div>').join('')}catch(e){}}
function renderSystemHealth(){const items=[{label:'API Server',status:'ok',value:'Operational'},{label:'PostgreSQL',status:'ok',value:'Connected'},{label:'Stripe',status:data.dashboard?.stripeConnected?'ok':'warn',value:data.dashboard?.stripeConnected?'Connected':'Not configured'},{label:'MDI',status:data.dashboard?.mdiConnected?'ok':'warn',value:data.dashboard?.mdiConnected?'Connected':'Not configured'},{label:'SSL',status:'ok',value:'Valid'},{label:'Uptime',status:'ok',value:'99.9%'}];document.getElementById('healthGrid').innerHTML=items.map(i=>'<div class="health-item"><span class="health-label">'+i.label+'</span><span class="health-val"><span class="health-dot '+i.status+'"></span>'+i.value+'</span></div>').join('');const el=document.getElementById('healthStatus');el.textContent=items.every(i=>i.status==='ok')?'All Systems Operational':'Attention Required';el.style.color=items.every(i=>i.status==='ok')?'var(--green)':'var(--amber)'}
function renderActivityFeed(){const activities=[];(data.customers||[]).slice(0,5).forEach(c=>{activities.push({type:'signup',text:'<strong>'+esc(c.name||c.email)+'</strong> signed up',time:c.createdAt})});(data.orders||[]).slice(0,5).forEach(o=>{activities.push({type:'order',text:'<strong>'+esc(o.customerName||o.customerEmail)+'</strong> placed $'+(o.amount/100).toFixed(0)+' order',time:o.createdAt})});activities.push({type:'visit',text:'System health check passed',time:new Date().toISOString()});activities.sort((a,b)=>new Date(b.time)-new Date(a.time));document.getElementById('activityFeed').innerHTML=activities.slice(0,12).map(a=>'<div class="activity-item"><div class="activity-dot '+a.type+'"></div><div><div class="activity-text">'+a.text+'</div><div class="activity-time">'+timeAgo(a.time)+'</div></div></div>').join('')||'<div class="empty">No activity yet</div>'}

// CUSTOMERS PAGE
let custTab='all';
function switchCustTab(tab){custTab=tab;document.querySelectorAll('#custTabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.ctab===tab));renderCustomersPage()}
function renderCustomersPage(){
const allCust=data._origCustomers||[];
const intakeCount=allCust.filter(c=>c.intakeStatus==='intake_completed').length;
const activeCount=allCust.filter(c=>(c.subscriptions||[]).some(s=>s?.status==='active')).length;
const flaggedCount=allCust.filter(c=>c.flaggedConditions&&c.flaggedConditions.length>0).length;
document.getElementById('custStats').innerHTML=
'<div class="stat-card purple"><div class="stat-icon">&#128101;</div><div class="stat-label">Total</div><div class="stat-value">'+allCust.length+'</div></div>'+
'<div class="stat-card cyan"><div class="stat-icon">&#128203;</div><div class="stat-label">Intake Done</div><div class="stat-value">'+intakeCount+'</div></div>'+
'<div class="stat-card mint"><div class="stat-icon">&#9889;</div><div class="stat-label">Active Subs</div><div class="stat-value">'+activeCount+'</div></div>'+
'<div class="stat-card amber"><div class="stat-icon">&#9888;</div><div class="stat-label">Flagged</div><div class="stat-value">'+flaggedCount+'</div></div>';

let items=data.customers||[];
if(custTab==='intake')items=items.filter(c=>c.intakeStatus==='intake_completed');
else if(custTab==='active')items=items.filter(c=>(c.subscriptions||[]).some(s=>s?.status==='active'));
else if(custTab==='flagged')items=items.filter(c=>c.flaggedConditions&&c.flaggedConditions.length>0);

if(!items.length){document.getElementById('custTable').innerHTML='<div class="empty">No customers found</div>';return}
document.getElementById('custTable').innerHTML='<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Intake</th><th>Screening</th><th>Subscription</th><th>Location</th><th>Joined</th></tr></thead><tbody>'+items.map(c=>{
const intakeClass=c.intakeStatus==='intake_completed'?'green':c.intakeStatus==='pending'?'amber':'cyan';
const screenClass=c.screeningClear?'green':(c.flaggedConditions&&c.flaggedConditions.length)?'amber':'';
const subBadges=(c.subscriptions||[]).map(s=>'<span class="badge '+(s?.status||'pending')+'">'+(s?.status||'none')+'</span>').join(' ')||'<span style="color:var(--text-muted)">None</span>';
return '<tr style="cursor:pointer" onclick="openCustomer('+c.id+')"><td><strong>'+esc(c.name)+'</strong><br><span style="color:var(--text-muted);font-size:11px">'+esc(c.email)+'</span>'+(c.phone?'<br><span style="color:var(--text-muted);font-size:11px">'+esc(c.phone)+'</span>':'')+'</td><td>'+(c.treatmentProduct?'<span class="badge '+(c.treatmentProduct||'')+'">'+esc(c.treatmentProduct||'—')+'</span>':'<span style="color:var(--text-muted)">—</span>')+'</td><td><span class="status-pill '+intakeClass+'">'+(c.intakeStatus||'pending')+'</span></td><td>'+(screenClass?'<span class="status-pill '+screenClass+'">'+(c.screeningClear?'Clear':'Flagged')+'</span>':'<span style="color:var(--text-muted)">—</span>')+'</td><td>'+subBadges+'</td><td style="font-size:12px;color:var(--text-dim)">'+esc([c.shippingCity,c.shippingState].filter(Boolean).join(', ')||'—')+'</td><td class="mono" style="color:var(--text-dim)">'+fmtDate(c.createdAt)+'</td></tr>'}).join('')+'</tbody></table>'}

function openCustomer(id){
const c=(data._origCustomers||[]).find(x=>x.id===id);
if(!c)return;
document.getElementById('drawerOverlay').classList.add('open');
document.getElementById('custDrawer').classList.add('open');
document.getElementById('drawerTitle').textContent=c.name||'Customer #'+c.id;
const age=c.dob?Math.floor((Date.now()-new Date(c.dob).getTime())/(365.25*86400000)):null;
const bmi=(c.heightFt&&c.heightIn&&c.weightLbs)?(c.weightLbs/Math.pow(c.heightFt*12+c.heightIn,2)*703).toFixed(1):null;
let html='';
// Status bar
const intakeClass=c.intakeStatus==='intake_completed'?'green':'amber';
const hasStripe=c.stripeId?true:false;
const hasSub=(c.subscriptions||[]).some(s=>s?.status==='active');
html+='<div class="detail-section"><div class="detail-section-title">Journey</div><div class="timeline">';
html+='<div class="timeline-item done"><span class="tl-label">Intake Submitted</span><br><span class="tl-date">'+fmtDate(c.createdAt)+'</span></div>';
html+='<div class="timeline-item '+(c.intakeStatus==='intake_completed'?'done':'current')+'"><span class="tl-label">Intake Reviewed</span></div>';
html+='<div class="timeline-item '+(hasStripe?'done':'')+'"><span class="tl-label">Payment Connected</span></div>';
html+='<div class="timeline-item '+(hasSub?'done':'')+'"><span class="tl-label">Subscription Active</span></div>';
html+='<div class="timeline-item"><span class="tl-label">Rx Sent to Pharmacy</span></div>';
html+='<div class="timeline-item"><span class="tl-label">Medication Shipped</span></div>';
html+='</div></div>';
// Personal
html+='<div class="detail-section"><div class="detail-section-title">Personal Information</div><div class="detail-grid">';
html+='<div class="detail-item"><div class="detail-item-label">Full Name</div><div class="detail-item-value">'+esc(c.name)+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Email</div><div class="detail-item-value">'+esc(c.email)+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Phone</div><div class="detail-item-value">'+esc(c.phone||'—')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">DOB / Age</div><div class="detail-item-value">'+(c.dob?fmtDate(c.dob)+(age?' ('+age+' yrs)':''):'—')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Sex</div><div class="detail-item-value">'+esc(c.sex||'—')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Height / Weight / BMI</div><div class="detail-item-value">'+(c.heightFt?c.heightFt+"'"+c.heightIn+'" / '+c.weightLbs+' lbs'+(bmi?' / BMI '+bmi:''):'—')+'</div></div>';
html+='</div></div>';
// Treatment
html+='<div class="detail-section"><div class="detail-section-title">Treatment</div><div class="detail-grid">';
html+='<div class="detail-item"><div class="detail-item-label">Selected Product</div><div class="detail-item-value">'+(c.treatmentProduct?'<span class="badge '+c.treatmentProduct+'">'+esc(c.treatmentProduct)+'</span>':'—')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Intake Status</div><div class="detail-item-value"><span class="status-pill '+intakeClass+'">'+(c.intakeStatus||'pending')+'</span></div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Screening</div><div class="detail-item-value">'+(c.screeningClear?'<span class="status-pill green">Clear</span>':(c.flaggedConditions&&c.flaggedConditions.length?'<span class="status-pill amber">Flagged</span>':'<span style="color:var(--text-muted)">Pending</span>'))+'</div></div>';
if(c.flaggedConditions&&c.flaggedConditions.length){html+='<div class="detail-item full"><div class="detail-item-label">Flagged Conditions</div><div class="detail-item-value" style="color:var(--amber)">'+c.flaggedConditions.map(f=>esc(f)).join(', ')+'</div></div>'}
html+='</div></div>';
// Shipping
html+='<div class="detail-section"><div class="detail-section-title">Shipping Address</div><div class="detail-grid">';
html+='<div class="detail-item full"><div class="detail-item-label">Address</div><div class="detail-item-value">'+esc([c.shippingStreet,c.shippingApt].filter(Boolean).join(', ')||'—')+'<br>'+esc([c.shippingCity,c.shippingState,c.shippingZip].filter(Boolean).join(', ')||'')+'</div></div>';
html+='</div></div>';
// Integrations
html+='<div class="detail-section"><div class="detail-section-title">Integrations</div><div class="detail-grid">';
html+='<div class="detail-item"><div class="detail-item-label">Stripe ID</div><div class="detail-item-value mono" style="font-size:11px">'+esc(c.stripeId||'Not connected')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">MDI Patient ID</div><div class="detail-item-value mono" style="font-size:11px">'+esc(c.mdiPatientId||'Not connected')+'</div></div>';
html+='<div class="detail-item"><div class="detail-item-label">Visitor ID</div><div class="detail-item-value mono" style="font-size:11px">'+esc(c.visitorId||'—')+'</div></div>';
if(c.utmSource||c.utmMedium||c.utmCampaign){html+='<div class="detail-item full"><div class="detail-item-label">UTM Attribution</div><div class="detail-item-value mono" style="font-size:11px">'+esc([c.utmSource,c.utmMedium,c.utmCampaign].filter(Boolean).join(' / '))+'</div></div>'}
html+='</div></div>';
// Subscriptions
const subs=c.subscriptions||[];
if(subs.length){html+='<div class="detail-section"><div class="detail-section-title">Subscriptions</div>';subs.forEach(s=>{if(!s)return;html+='<div style="padding:12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><span class="badge '+(s.product_type||'')+'">'+esc(s.product_type||'—')+'</span><span class="badge '+(s.status||'pending')+'">'+esc(s.status||'—')+'</span></div><div style="margin-top:8px;font-size:12px;color:var(--text-dim)">'+esc(s.plan_type||'')+' — $'+((s.amount_cents||0)/100).toFixed(2)+(s.current_period_end?' — Renews '+ new Date(s.current_period_end).toLocaleDateString():'')+'</div></div>'});html+='</div>'}
document.getElementById('drawerBody').innerHTML=html}

function closeDrawer(){document.getElementById('drawerOverlay').classList.remove('open');document.getElementById('custDrawer').classList.remove('open')}

// ORDERS PAGE
function renderOrdersPage(){const s=data.dashboard?.stats||{};document.getElementById('orderStats').innerHTML='<div class="stat-card mint"><div class="stat-icon">&#128176;</div><div class="stat-label">Revenue This Month</div><div class="stat-value">$'+fmt(s.monthRevenue)+'</div></div><div class="stat-card cyan"><div class="stat-icon">&#128260;</div><div class="stat-label">MRR</div><div class="stat-value">$'+fmt(s.mrr)+'</div></div><div class="stat-card purple"><div class="stat-icon">&#128179;</div><div class="stat-label">Total Orders</div><div class="stat-value">'+(data.orders?.length||0)+'</div></div><div class="stat-card amber"><div class="stat-icon">&#128200;</div><div class="stat-label">Active Subs</div><div class="stat-value">'+(s.activeSubscriptions||0)+'</div></div>';renderOrderTable()}
function renderOrderTable(){const el=document.getElementById('orderTable');if(orderTab==='subscriptions'){const items=data.subs||[];if(!items.length){el.innerHTML='<div class="empty">No subscriptions yet</div>';return}el.innerHTML='<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Plan</th><th>Amount</th><th>Status</th><th>Renews</th><th></th></tr></thead><tbody>'+items.map(s=>'<tr><td><strong>'+esc(s.customerName)+'</strong><br><span style="color:var(--text-muted);font-size:11px">'+esc(s.customerEmail)+'</span></td><td><span class="badge '+s.productType+'">'+esc(s.productType)+'</span></td><td>'+s.planType+'</td><td class="mono" style="font-weight:700;color:var(--green)">$'+(s.amount/100).toFixed(2)+'</td><td><span class="badge '+s.status+'">'+s.status+'</span></td><td class="mono" style="color:var(--text-dim)">'+(s.periodEnd?new Date(s.periodEnd).toLocaleDateString():'—')+'</td><td>'+(s.status==='active'?'<button class="action-btn danger" onclick="cancelSub('+s.id+')">Cancel</button>':'')+'</td></tr>').join('')+'</tbody></table>'}else{const items=data.orders||[];if(!items.length){el.innerHTML='<div class="empty">No orders yet</div>';return}el.innerHTML='<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Amount</th><th>Payment</th><th>Pharmacy</th><th>Tracking</th><th>Date</th></tr></thead><tbody>'+items.map(o=>'<tr><td><strong>'+esc(o.customerName)+'</strong><br><span style="color:var(--text-muted);font-size:11px">'+esc(o.customerEmail)+'</span></td><td><span class="badge '+o.productType+'">'+esc(o.productType||'—')+'</span></td><td class="mono" style="font-weight:700;color:var(--green)">$'+(o.amount/100).toFixed(2)+'</td><td><span class="badge '+o.status+'">'+o.status+'</span></td><td>'+(o.pharmacyStatus?'<span class="badge '+o.pharmacyStatus+'">'+o.pharmacyStatus+'</span>':'—')+'</td><td class="mono" style="font-size:11px">'+(o.trackingNumber||'—')+'</td><td class="mono" style="color:var(--text-dim)">'+fmtDate(o.createdAt)+'</td></tr>').join('')+'</tbody></table>'}}

async function cancelSub(id){if(!confirm('Cancel this subscription?'))return;try{await fetch(API+'/admin/cancel-subscription',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({subscriptionId:id,immediate:false})});await loadAll()}catch(e){alert('Failed: '+e.message)}}
function handleSearch(){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>{const q=(document.getElementById('custSearch')?.value||document.getElementById('orderSearch')?.value||'').toLowerCase();if(!q){data.subs=data._origSubs;data.customers=data._origCustomers;data.orders=data._origOrders}else{data.subs=(data._origSubs||[]).filter(s=>s.customerEmail?.toLowerCase().includes(q)||s.customerName?.toLowerCase().includes(q));data.customers=(data._origCustomers||[]).filter(c=>c.email?.toLowerCase().includes(q)||c.name?.toLowerCase().includes(q));data.orders=(data._origOrders||[]).filter(o=>o.customerEmail?.toLowerCase().includes(q)||o.customerName?.toLowerCase().includes(q))}if(currentPage==='customers')renderCustomersPage();if(currentPage==='orders')renderOrderTable()},200)}

function fmt(cents){return((cents||0)/100).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}
function fmtDate(d){if(!d)return'—';return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function timeAgo(t){if(!t)return'';const diff=(Date.now()-new Date(t).getTime())/1000;if(diff<60)return'just now';if(diff<3600)return Math.floor(diff/60)+'m ago';if(diff<86400)return Math.floor(diff/3600)+'h ago';return Math.floor(diff/86400)+'d ago'}
if(token)showDash().catch(()=>doLogout());
</script>
</body>
</html>
