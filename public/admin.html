<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLYR Health — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(0,212,255,0.15)}50%{box-shadow:0 0 40px rgba(0,212,255,0.25)}}
@keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes borderGlow{0%,100%{border-color:rgba(255,255,255,0.06)}50%{border-color:rgba(255,255,255,0.12)}}
:root{
  --bg:#050507;--surface:rgba(255,255,255,0.03);--surface-2:rgba(255,255,255,0.05);--surface-3:rgba(255,255,255,0.08);
  --glass:rgba(255,255,255,0.04);--glass-border:rgba(255,255,255,0.08);--glass-border-hover:rgba(255,255,255,0.14);
  --cyan:#00d4ff;--cyan-dim:rgba(0,212,255,0.1);--cyan-glow:rgba(0,212,255,0.3);
  --green:#34d399;--green-dim:rgba(52,211,153,0.1);--green-glow:rgba(52,211,153,0.25);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.1);
  --rose:#fb7185;--rose-dim:rgba(251,113,133,0.1);
  --amber:#fbbf24;--amber-dim:rgba(251,191,36,0.1);
  --text:rgba(255,255,255,0.9);--text-dim:rgba(255,255,255,0.4);--text-muted:rgba(255,255,255,0.25);
  --font:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 20%,rgba(0,212,255,0.03) 0%,transparent 50%),radial-gradient(circle at 70% 80%,rgba(167,139,250,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:10px}

/* LOGIN */
#loginView{display:flex;align-items:center;justify-content:center;min-height:100vh;position:relative;z-index:1}
.login-box{background:var(--glass);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1px solid var(--glass-border);border-radius:28px;padding:56px 48px;width:440px;text-align:center;animation:fadeUp .8s ease}
.login-logo{font-size:42px;font-weight:900;letter-spacing:-2px;margin-bottom:4px;background:linear-gradient(135deg,#fff 0%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{color:var(--text-dim);font-size:13px;margin-bottom:36px;font-weight:500;letter-spacing:2px;text-transform:uppercase}
.login-box input{width:100%;padding:16px 20px;margin-bottom:14px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);border-radius:14px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;transition:all .3s}
.login-box input:focus{border-color:var(--cyan);background:rgba(0,212,255,0.04);box-shadow:0 0 0 4px rgba(0,212,255,0.08)}
.login-box input::placeholder{color:var(--text-muted)}
.login-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:var(--font);font-size:15px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff;transition:all .3s;letter-spacing:.5px;position:relative;overflow:hidden}
.login-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);transition:.6s}
.login-btn:hover::after{left:100%}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,212,255,0.3)}
#loginErr{color:var(--rose);font-size:13px;margin-top:16px;min-height:18px;font-weight:500}

/* DASHBOARD */
#dashView{display:none;position:relative;z-index:1}
.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:16px 32px;background:rgba(5,5,7,0.7);backdrop-filter:blur(30px);border-bottom:1px solid var(--glass-border)}
.topbar-left{display:flex;align-items:center;gap:16px}
.topbar-logo{font-size:22px;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#fff,var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.topbar-badge{padding:5px 14px;border-radius:20px;font-size:10px;font-weight:700;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(0,102,255,0.15));color:var(--cyan);text-transform:uppercase;letter-spacing:1.5px;border:1px solid rgba(0,212,255,0.2)}
.topbar-right{display:flex;gap:10px;align-items:center}
.live-indicator{display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15);margin-right:8px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;box-shadow:0 0 8px var(--green)}
.live-count{font-size:12px;font-weight:700;color:var(--green)}
.btn{padding:9px 18px;border-radius:10px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--glass-border);transition:all .3s;background:var(--glass);color:var(--text-dim);letter-spacing:.3px}
.btn:hover{border-color:var(--glass-border-hover);color:var(--text);background:var(--surface-2)}
.btn-danger{border-color:rgba(251,113,133,0.2);color:var(--rose);background:rgba(251,113,133,0.06)}
.btn-danger:hover{background:var(--rose);color:#fff;border-color:var(--rose)}
.container{max-width:1600px;margin:0 auto;padding:28px 32px}

/* LIVE BAR */
.live-bar{display:flex;align-items:center;gap:20px;padding:16px 24px;background:linear-gradient(135deg,rgba(52,211,153,0.04),rgba(0,212,255,0.02));border:1px solid rgba(52,211,153,0.1);border-radius:16px;margin-bottom:28px;animation:fadeUp .5s ease}
.live-bar-num{font-size:28px;font-weight:900;color:var(--green);font-family:var(--mono)}
.live-bar-label{font-size:13px;color:var(--text-dim);font-weight:500}
.live-pages{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
.live-page{padding:5px 12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;font-size:11px;color:var(--text-dim);font-weight:600;font-family:var(--mono)}
.live-page .cnt{color:var(--cyan);margin-right:6px}

/* GLASS CARD */
.glass{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;transition:all .4s;overflow:hidden}
.glass:hover{border-color:var(--glass-border-hover)}

/* STATS GRID */
.stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;margin-bottom:28px}
.stat-card{position:relative;padding:24px;border-radius:20px;overflow:hidden;transition:all .4s;border:1px solid var(--glass-border);animation:fadeUp .6s ease backwards}
.stat-card:nth-child(1){animation-delay:.05s}.stat-card:nth-child(2){animation-delay:.1s}.stat-card:nth-child(3){animation-delay:.15s}
.stat-card:nth-child(4){animation-delay:.2s}.stat-card:nth-child(5){animation-delay:.25s}.stat-card:nth-child(6){animation-delay:.3s}
.stat-card::before{content:'';position:absolute;inset:0;opacity:.6;z-index:0;border-radius:20px}
.stat-card:hover{transform:translateY(-4px);border-color:var(--glass-border-hover)}
.stat-card.mint::before{background:linear-gradient(135deg,rgba(52,211,153,0.08),rgba(52,211,153,0.02))}
.stat-card.cyan::before{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(0,212,255,0.02))}
.stat-card.purple::before{background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(167,139,250,0.02))}
.stat-card.amber::before{background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(251,191,36,0.02))}
.stat-card.blue::before{background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(96,165,250,0.02))}
.stat-card.rose::before{background:linear-gradient(135deg,rgba(251,113,133,0.08),rgba(251,113,133,0.02))}
.stat-card *{position:relative;z-index:1}
.stat-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:14px;border:1px solid var(--glass-border)}
.stat-card.mint .stat-icon{background:var(--green-dim);border-color:rgba(52,211,153,0.2)}
.stat-card.cyan .stat-icon{background:var(--cyan-dim);border-color:rgba(0,212,255,0.2)}
.stat-card.purple .stat-icon{background:var(--purple-dim);border-color:rgba(167,139,250,0.2)}
.stat-card.amber .stat-icon{background:var(--amber-dim);border-color:rgba(251,191,36,0.2)}
.stat-card.blue .stat-icon{background:rgba(96,165,250,0.1);border-color:rgba(96,165,250,0.2)}
.stat-card.rose .stat-icon{background:var(--rose-dim);border-color:rgba(251,113,133,0.2)}
.stat-label{font-size:11px;color:var(--text-dim);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:900;letter-spacing:-1px;line-height:1;font-family:var(--mono);animation:countUp .6s ease}
.stat-card.mint .stat-value{color:var(--green)}.stat-card.cyan .stat-value{color:var(--cyan)}
.stat-card.purple .stat-value{color:var(--purple)}.stat-card.amber .stat-value{color:var(--amber)}
.stat-card.blue .stat-value{color:#60a5fa}.stat-card.rose .stat-value{color:var(--rose)}
.stat-sub{font-size:11px;color:var(--text-dim);margin-top:8px;font-weight:500;display:flex;align-items:center;gap:4px}
.stat-sub .up{color:var(--green)}.stat-sub .down{color:var(--rose)}
.sparkline-wrap{position:absolute;bottom:0;right:0;width:90px;height:45px;opacity:.25}

/* GRID LAYOUTS */
.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
.grid-2-equal{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--glass-border)}
.card-title{font-size:14px;font-weight:700;letter-spacing:-.2px}
.card-body{padding:24px}.card-body.compact{padding:0}
.chart-wrap{height:270px;position:relative}
.select-sm{background:var(--glass);border:1px solid var(--glass-border);color:var(--text-dim);padding:6px 12px;border-radius:8px;font-size:11px;font-family:var(--font);font-weight:600;cursor:pointer;transition:all .3s}
.select-sm:hover{border-color:var(--glass-border-hover)}

/* ACTIVITY */
.activity-list{max-height:370px;overflow-y:auto}
.activity-item{display:flex;gap:14px;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,0.03);align-items:flex-start;transition:background .2s}
.activity-item:hover{background:rgba(255,255,255,0.02)}
.activity-dot{width:8px;height:8px;border-radius:50%;margin-top:6px;flex-shrink:0}
.activity-dot.signup{background:var(--green);box-shadow:0 0 6px var(--green-glow)}
.activity-dot.order{background:var(--cyan);box-shadow:0 0 6px var(--cyan-glow)}
.activity-dot.visit{background:var(--purple);box-shadow:0 0 6px rgba(167,139,250,0.3)}
.activity-text{font-size:13px;line-height:1.5;color:var(--text-dim)}.activity-text strong{color:var(--text);font-weight:600}
.activity-time{font-size:10px;color:var(--text-muted);margin-top:2px;font-family:var(--mono)}

/* FUNNEL */
.funnel-step{display:flex;align-items:center;gap:16px;padding:16px 24px;border-bottom:1px solid rgba(255,255,255,0.03)}
.funnel-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden}
.funnel-bar{height:100%;border-radius:4px;transition:width 1.2s cubic-bezier(.23,1,.32,1)}
.funnel-label{font-size:13px;font-weight:600;min-width:150px}.funnel-value{font-size:14px;font-weight:800;min-width:50px;text-align:right;font-family:var(--mono)}
.funnel-pct{font-size:11px;color:var(--text-muted);min-width:45px;text-align:right;font-family:var(--mono)}

/* HEALTH */
.health-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:rgba(255,255,255,0.03)}
.health-item{padding:18px 24px;background:var(--bg);display:flex;align-items:center;justify-content:space-between}
.health-label{font-size:12px;color:var(--text-dim);font-weight:600}
.health-val{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.health-dot{width:7px;height:7px;border-radius:50%}.health-dot.ok{background:var(--green);box-shadow:0 0 8px var(--green-glow)}.health-dot.warn{background:var(--amber);box-shadow:0 0 8px rgba(251,191,36,0.3)}

/* MAP */
#mapContainer{height:500px;background:var(--bg)}
.leaflet-tile-pane{filter:brightness(0.5) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.6)}
.leaflet-container{background:var(--bg)!important}
.map-legend{display:flex;gap:20px;padding:14px 24px;border-top:1px solid var(--glass-border);font-size:11px;color:var(--text-dim);font-weight:500}
.map-legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}

/* TABS + TABLE */
.section-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px}
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--glass);border-radius:12px;padding:4px;border:1px solid var(--glass-border);width:fit-content}
.tab{padding:9px 22px;border-radius:10px;font-size:12px;font-weight:700;color:var(--text-dim);cursor:pointer;transition:all .3s;letter-spacing:.3px}
.tab:hover{color:var(--text)}.tab.active{background:linear-gradient(135deg,var(--cyan),#0066ff);color:#fff;box-shadow:0 4px 15px rgba(0,212,255,0.2)}
.data-table{width:100%;border-collapse:collapse}
.data-table th{text-align:left;padding:14px 20px;font-size:10px;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1.5px;border-bottom:1px solid var(--glass-border);background:rgba(255,255,255,0.02)}
.data-table td{padding:14px 20px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
.data-table tr:hover td{background:rgba(0,212,255,0.02)}
.mono{font-family:var(--mono);font-size:12px}
.badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.badge.active{background:var(--green-dim);color:var(--green)}.badge.canceled{background:var(--rose-dim);color:var(--rose)}
.badge.past_due{background:var(--amber-dim);color:var(--amber)}.badge.pending,.badge.shipped{background:var(--cyan-dim);color:var(--cyan)}
.badge.paid{background:var(--green-dim);color:var(--green)}.badge.tirzepatide{background:var(--cyan-dim);color:var(--cyan)}.badge.semaglutide{background:var(--purple-dim);color:var(--purple)}
.empty{text-align:center;padding:60px;color:var(--text-muted);font-size:14px}
.search-bar{padding:11px 18px;background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:var(--font);font-size:13px;width:320px;outline:none;margin-bottom:16px;transition:all .3s}
.search-bar:focus{border-color:rgba(0,212,255,0.3);box-shadow:0 0 0 4px rgba(0,212,255,0.06)}
.table-wrap{border-radius:20px;overflow:hidden;border:1px solid var(--glass-border);background:var(--glass)}
.action-btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--glass-border);background:var(--glass);color:var(--text-dim);transition:all .3s;font-family:var(--font)}
.action-btn:hover{border-color:var(--cyan);color:var(--cyan)}.action-btn.danger:hover{border-color:var(--rose);color:var(--rose)}
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(3,1fr)}.grid-2,.grid-2-equal{grid-template-columns:1fr}}
@media(max-width:768px){.stats-grid{grid-template-columns:1fr 1fr}.container{padding:16px}.topbar{padding:12px 16px}.health-grid{grid-template-columns:1fr}.live-bar{flex-wrap:wrap}.live-pages{margin-left:0}}
</style>
</head>
<body>
<div id="loginView">
  <div class="login-box">
    <div class="login-logo">CLYR Health</div>
    <div class="login-sub">Command Center</div>
    <input type="email" id="email" placeholder="Email" autocomplete="email">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div id="loginErr"></div>
  </div>
</div>
<div id="dashView">
  <div class="topbar">
    <div class="topbar-left"><div class="topbar-logo">CLYR Command Center</div><div class="topbar-badge">Admin</div></div>
    <div class="topbar-right">
      <div class="live-indicator"><span class="live-dot"></span><span class="live-count" id="topLive">0 live</span></div>
      <button class="btn" onclick="loadAll()">Refresh</button>
      <button class="btn btn-danger" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="container">
    <div class="live-bar"><div class="live-bar-num" id="liveCount">0</div><div><div class="live-bar-label">Active visitors right now</div></div><div class="live-pages" id="livePages"></div></div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="grid-2">
      <div class="glass"><div class="card-header"><div class="card-title">Revenue Overview</div></div><div class="card-body"><div class="chart-wrap"><canvas id="revenueChart"></canvas></div></div></div>
      <div class="glass"><div class="card-header"><div class="card-title">Activity Feed</div></div><div class="card-body compact"><div class="activity-list" id="activityFeed"></div></div></div>
    </div>
    <div class="grid-2-equal">
      <div class="glass"><div class="card-header"><div class="card-title">Conversion Funnel</div><select class="select-sm" id="funnelPeriod" onchange="loadFunnel()"><option value="7d">7 days</option><option value="14d">14 days</option><option value="30d" selected>30 days</option><option value="60d">60 days</option><option value="90d">90 days</option></select></div><div class="card-body compact" id="funnelWrap"></div></div>
      <div class="glass"><div class="card-header"><div class="card-title">Product Mix</div></div><div class="card-body"><div style="height:220px;position:relative"><canvas id="productChart"></canvas></div></div></div>
    </div>
    <div class="glass" style="margin-bottom:24px"><div class="card-header"><div class="card-title">System Health</div><span style="font-size:11px;font-weight:700" id="healthStatus">All Systems Operational</span></div><div class="card-body compact"><div class="health-grid" id="healthGrid"></div></div></div>
    <div class="section-label">Data Explorer</div>
    <div class="tabs" id="tabs"><div class="tab active" data-tab="subscriptions">Subscriptions</div><div class="tab" data-tab="customers">Customers</div><div class="tab" data-tab="orders">Orders</div></div>
    <input class="search-bar" id="searchBar" placeholder="Search by email, name..." oninput="handleSearch()">
    <div class="table-wrap" id="content"></div>
    <div class="glass" style="margin-top:24px"><div class="card-header"><div class="card-title">Visitor Map</div><select class="select-sm" id="mapPeriod" onchange="loadGeoData()"><option value="1h">Last hour</option><option value="24h" selected>Last 24 hours</option><option value="7d">Last 7 days</option><option value="30d">Last 30 days</option></select></div><div id="mapContainer"></div><div class="map-legend"><span><span class="map-legend-dot" style="background:var(--green)"></span>Active now</span><span><span class="map-legend-dot" style="background:var(--cyan)"></span>Recent</span><span id="mapStats" style="margin-left:auto;font-weight:600;font-family:var(--mono)"></span></div></div>
  </div>
</div>
<script>
const API=window.location.origin+'/api';let token=localStorage.getItem('th_admin_token'),currentTab='subscriptions',data={},searchTimeout,revenueChartInstance=null,productChartInstance=null,refreshInterval=null,visitorMap=null,mapMarkers=[];

async function doLogin(){const email=document.getElementById('email').value,pw=document.getElementById('password').value,err=document.getElementById('loginErr');err.textContent='Signing in...';try{const r=await fetch(API+'/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pw})});const text=await r.text();let d;try{d=JSON.parse(text)}catch(e){err.textContent='Server starting, retry in 10s';return}if(!r.ok){err.textContent=d.error||'Login failed';return}token=d.token;localStorage.setItem('th_admin_token',token);err.textContent='';showDash()}catch(e){err.textContent='Connection error: '+e.message}}
function doLogout(){localStorage.removeItem('th_admin_token');token=null;if(refreshInterval)clearInterval(refreshInterval);document.getElementById('dashView').style.display='none';document.getElementById('loginView').style.display='flex'}
async function apiFetch(path){const r=await fetch(API+path,{headers:{Authorization:'Bearer '+token}});if(r.status===401){doLogout();throw new Error('Unauthorized')}if(!r.ok)throw new Error('API error');return r.json()}
async function showDash(){document.getElementById('loginView').style.display='none';document.getElementById('dashView').style.display='block';initMap();await loadAll();if(refreshInterval)clearInterval(refreshInterval);refreshInterval=setInterval(()=>{loadLiveData();loadGeoData()},30000)}
async function loadAll(){try{const[dashboard,subs,customers,orders]=await Promise.all([apiFetch('/admin/dashboard'),apiFetch('/admin/subscriptions'),apiFetch('/admin/customers'),apiFetch('/admin/orders')]);data={dashboard,subs:subs.subscriptions,_origSubs:subs.subscriptions,customers:customers.customers,_origCustomers:customers.customers,orders:orders.orders,_origOrders:orders.orders};renderStats();renderTab();renderRevenueChart();renderProductChart();renderSystemHealth();renderActivityFeed();loadLiveData();loadFunnel();loadGeoData()}catch(e){console.error('Load error:',e)}}
async function loadLiveData(){try{const live=await apiFetch('/admin/analytics/live');animateCounter('liveCount',live.activeVisitors||0);document.getElementById('topLive').textContent=(live.activeVisitors||0)+' live';document.getElementById('livePages').innerHTML=(live.pages||[]).map(p=>'<div class="live-page"><span class="cnt">'+p.count+'</span>'+esc(p.page)+'</div>').join('')}catch(e){}}

function animateCounter(id,target){const el=document.getElementById(id);if(!el)return;const start=parseInt(el.textContent)||0;if(start===target){el.textContent=target;return}const duration=600;const startTime=performance.now();function step(now){const progress=Math.min((now-startTime)/duration,1);const eased=1-Math.pow(1-progress,3);el.textContent=Math.round(start+(target-start)*eased);if(progress<1)requestAnimationFrame(step)}requestAnimationFrame(step)}

function renderStats(){const s=data.dashboard?.stats||{};document.getElementById('statsGrid').innerHTML=
'<div class="stat-card mint"><div class="stat-icon">&#128176;</div><div class="stat-label">Monthly Revenue</div><div class="stat-value">$'+fmt(s.monthRevenue)+'</div><div class="stat-sub"><span class="up">$'+fmt(s.totalRevenue)+'</span> all time</div></div>'+
'<div class="stat-card cyan"><div class="stat-icon">&#9889;</div><div class="stat-label">MRR</div><div class="stat-value">$'+fmt(s.mrr)+'</div><div class="stat-sub">Recurring</div></div>'+
'<div class="stat-card purple"><div class="stat-icon">&#128200;</div><div class="stat-label">Active Subs</div><div class="stat-value">'+(s.activeSubscriptions||0)+'</div><div class="stat-sub"><span class="up">+'+(s.recentSignups||0)+'</span> this week</div></div>'+
'<div class="stat-card amber"><div class="stat-icon">&#128101;</div><div class="stat-label">Customers</div><div class="stat-value">'+(s.totalCustomers||0)+'</div><div class="stat-sub">'+(s.recentSignups||0)+' recent</div></div>'+
'<div class="stat-card blue"><div class="stat-icon">&#127760;</div><div class="stat-label">Visitors</div><div class="stat-value">'+(s.monthlyVisitors||0)+'</div><div class="stat-sub">'+(s.todayVisitors||0)+' today</div></div>'+
'<div class="stat-card rose"><div class="stat-icon">&#128201;</div><div class="stat-label">Churn (30d)</div><div class="stat-value">'+(s.churn30d||0)+'</div><div class="stat-sub">'+((s.churn30d||0)>0?'<span class="down">Watch closely</span>':'<span class="up">Zero churn!</span>')+'</div></div>'}

function renderRevenueChart(){const ctx=document.getElementById('revenueChart').getContext('2d');const cd=data.dashboard?.revenueChart||[];const labels=[],values=[],today=new Date();for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const key=d.toISOString().split('T')[0];labels.push(d.toLocaleDateString('en',{month:'short',day:'numeric'}));const m=cd.find(c=>c.date&&c.date.startsWith(key));values.push(m?(parseInt(m.revenue)/100):0)}
if(revenueChartInstance)revenueChartInstance.destroy();const gradient=ctx.createLinearGradient(0,0,0,270);gradient.addColorStop(0,'rgba(0,212,255,0.15)');gradient.addColorStop(1,'rgba(0,212,255,0)');
revenueChartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:values,borderColor:'#00d4ff',backgroundColor:gradient,borderWidth:2,fill:true,tension:.4,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:'#00d4ff',pointHoverBorderColor:'#fff',pointHoverBorderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,titleFont:{family:'Outfit',weight:'600'},bodyFont:{family:'JetBrains Mono'},padding:12,cornerRadius:10,callbacks:{label:c=>'$'+c.parsed.y.toLocaleString()}}},scales:{x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'rgba(255,255,255,0.25)',font:{size:11,family:'Outfit'},maxTicksLimit:8}},y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'rgba(255,255,255,0.25)',font:{size:11,family:'JetBrains Mono'},callback:v=>'$'+v}}},interaction:{intersect:false,mode:'index'}}})}

function renderProductChart(){const ctx=document.getElementById('productChart').getContext('2d');const bp=data.dashboard?.byProduct||[];const labels=bp.length?bp.map(p=>p.product_type||'Unknown'):['Semaglutide','Tirzepatide'];const values=bp.length?bp.map(p=>parseInt(p.count)):[0,0];const colors=['#00d4ff','#a78bfa','#34d399','#fbbf24'];if(productChartInstance)productChartInstance.destroy();productChartInstance=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values.some(v=>v>0)?values:[1],backgroundColor:values.some(v=>v>0)?colors:['rgba(255,255,255,0.05)'],borderWidth:0,borderRadius:6,spacing:3}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{position:'bottom',labels:{color:'rgba(255,255,255,0.4)',font:{size:12,family:'Outfit',weight:'600'},padding:16,usePointStyle:true,pointStyle:'circle'}}}}})}

function initMap(){if(visitorMap)return;visitorMap=L.map('mapContainer',{zoomControl:true,attributionControl:false}).setView([39.8,-98.5],4);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(visitorMap);setTimeout(()=>visitorMap.invalidateSize(),200)}
async function loadGeoData(){try{const period=document.getElementById('mapPeriod').value;const geo=await apiFetch('/admin/analytics/geo?period='+period);mapMarkers.forEach(m=>visitorMap.removeLayer(m));mapMarkers=[];
const activeIcon=L.divIcon({className:'',html:'<div style="width:12px;height:12px;background:#34d399;border-radius:50%;border:2px solid #fff;box-shadow:0 0 12px rgba(52,211,153,0.6)"></div>',iconSize:[12,12],iconAnchor:[6,6]});
(geo.activeNow||[]).forEach(p=>{if(p.lat&&p.lng){const m=L.marker([p.lat,p.lng],{icon:activeIcon}).addTo(visitorMap).bindPopup('<b>Active Now</b><br>'+esc(p.city||'')+', '+esc(p.state||''));mapMarkers.push(m)}});
(geo.byCity||[]).forEach(p=>{if(p.lat&&p.lng){const m=L.circleMarker([parseFloat(p.lat),parseFloat(p.lng)],{radius:Math.min(4+parseInt(p.visitors)*2,20),fillColor:'#00d4ff',fillOpacity:0.4,color:'#00d4ff',weight:1,opacity:0.5}).addTo(visitorMap).bindPopup('<b>'+esc(p.city)+', '+esc(p.state)+'</b><br>'+p.visitors+' visitors');mapMarkers.push(m)}});
const total=(geo.byCity||[]).reduce((s,c)=>s+parseInt(c.visitors),0);document.getElementById('mapStats').textContent=total+' visitors from '+(geo.byCity||[]).length+' cities'}catch(e){document.getElementById('mapStats').textContent='No data yet'}}

async function loadFunnel(){try{const period=document.getElementById('funnelPeriod').value;const funnel=await apiFetch('/admin/analytics/funnel?period='+period);const steps=funnel.steps||[];const colors=['#00d4ff','#a78bfa','#fbbf24','#fb923c','#34d399'];const max=Math.max(...steps.map(s=>s.value),1);document.getElementById('funnelWrap').innerHTML=steps.map((st,i)=>'<div class="funnel-step"><div class="funnel-label">'+st.label+'</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:'+(st.value/max)*100+'%;background:'+colors[i]+'"></div></div><div class="funnel-value" style="color:'+colors[i]+'">'+st.value.toLocaleString()+'</div><div class="funnel-pct">'+(i===0?'100%':steps[0].value>0?((st.value/steps[0].value)*100).toFixed(1)+'%':'0%')+'</div></div>').join('')}catch(e){document.getElementById('funnelWrap').innerHTML='<div class="empty">Unable to load</div>'}}

function renderSystemHealth(){const items=[{label:'API Server',status:'ok',value:'Operational'},{label:'PostgreSQL',status:'ok',value:'Connected'},{label:'Stripe',status:data.dashboard?.stripeConnected?'ok':'warn',value:data.dashboard?.stripeConnected?'Connected':'Not configured'},{label:'MDI Integration',status:data.dashboard?.mdiConnected?'ok':'warn',value:data.dashboard?.mdiConnected?'Connected':'Not configured'},{label:'SSL Certificate',status:'ok',value:'Valid'},{label:'Uptime',status:'ok',value:'99.9%'}];document.getElementById('healthGrid').innerHTML=items.map(i=>'<div class="health-item"><span class="health-label">'+i.label+'</span><span class="health-val"><span class="health-dot '+i.status+'"></span>'+i.value+'</span></div>').join('');const el=document.getElementById('healthStatus');const allOk=items.every(i=>i.status==='ok');el.textContent=allOk?'All Systems Operational':'Attention Required';el.style.color=allOk?'var(--green)':'var(--amber)'}

function renderActivityFeed(){const activities=[];(data.customers||[]).slice(0,5).forEach(c=>{activities.push({type:'signup',text:'<strong>'+esc(c.name||c.email)+'</strong> signed up',time:c.createdAt})});(data.orders||[]).slice(0,5).forEach(o=>{activities.push({type:'order',text:'<strong>'+esc(o.customerName||o.customerEmail)+'</strong> placed $'+(o.amount/100).toFixed(0)+' order',time:o.createdAt})});activities.push({type:'visit',text:'System health check passed',time:new Date().toISOString()});activities.sort((a,b)=>new Date(b.time)-new Date(a.time));document.getElementById('activityFeed').innerHTML=activities.length?activities.slice(0,12).map(a=>'<div class="activity-item"><div class="activity-dot '+a.type+'"></div><div><div class="activity-text">'+a.text+'</div><div class="activity-time">'+timeAgo(a.time)+'</div></div></div>').join(''):'<div class="empty">No activity yet</div>'}

function renderTab(){const el=document.getElementById('content');document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===currentTab));
if(currentTab==='subscriptions'){const items=data.subs||[];if(!items.length){el.innerHTML='<div class="empty">No subscriptions yet</div>';return}el.innerHTML='<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Plan</th><th>Amount</th><th>Status</th><th>Renews</th><th></th></tr></thead><tbody>'+items.map(s=>'<tr><td><strong>'+esc(s.customerName)+'</strong><br><span style="color:var(--text-muted);font-size:11px">'+esc(s.customerEmail)+'</span></td><td><span class="badge '+s.productType+'">'+esc(s.productType)+'</span></td><td>'+s.planType+'</td><td class="mono" style="font-weight:700;color:var(--green)">$'+(s.amount/100).toFixed(2)+'</td><td><span class="badge '+s.status+'">'+s.status+'</span></td><td class="mono" style="color:var(--text-dim)">'+(s.periodEnd?new Date(s.periodEnd).toLocaleDateString():'—')+'</td><td>'+(s.status==='active'?'<button class="action-btn danger" onclick="cancelSub('+s.id+')">Cancel</button>':'')+'</td></tr>').join('')+'</tbody></table>'}
else if(currentTab==='customers'){const items=data.customers||[];if(!items.length){el.innerHTML='<div class="empty">No customers yet</div>';return}el.innerHTML='<table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Shipping</th><th>Subscriptions</th><th>Joined</th></tr></thead><tbody>'+items.map(c=>'<tr><td><strong>'+esc(c.name)+'</strong></td><td class="mono">'+esc(c.email)+'</td><td style="max-width:200px;font-size:12px;color:var(--text-dim)">'+esc(c.shipping)+'</td><td>'+((c.subscriptions||[]).map(s=>'<span class="badge '+(s?.status||'pending')+'">'+(s?.product_type||'?')+'</span>').join(' ')||'—')+'</td><td class="mono" style="color:var(--text-dim)">'+fmtDate(c.createdAt)+'</td></tr>').join('')+'</tbody></table>'}
else if(currentTab==='orders'){const items=data.orders||[];if(!items.length){el.innerHTML='<div class="empty">No orders yet</div>';return}el.innerHTML='<table class="data-table"><thead><tr><th>Customer</th><th>Product</th><th>Amount</th><th>Payment</th><th>Pharmacy</th><th>Tracking</th><th>Date</th></tr></thead><tbody>'+items.map(o=>'<tr><td><strong>'+esc(o.customerName)+'</strong><br><span style="color:var(--text-muted);font-size:11px">'+esc(o.customerEmail)+'</span></td><td><span class="badge '+o.productType+'">'+esc(o.productType||'—')+'</span></td><td class="mono" style="font-weight:700;color:var(--green)">$'+(o.amount/100).toFixed(2)+'</td><td><span class="badge '+o.status+'">'+o.status+'</span></td><td>'+(o.pharmacyStatus?'<span class="badge '+o.pharmacyStatus+'">'+o.pharmacyStatus+'</span>':'—')+'</td><td class="mono" style="font-size:11px">'+(o.trackingNumber||'—')+'</td><td class="mono" style="color:var(--text-dim)">'+fmtDate(o.createdAt)+'</td></tr>').join('')+'</tbody></table>'}}

async function cancelSub(id){if(!confirm('Cancel this subscription?'))return;try{await fetch(API+'/admin/cancel-subscription',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({subscriptionId:id,immediate:false})});await loadAll()}catch(e){alert('Failed: '+e.message)}}
function handleSearch(){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>{const q=document.getElementById('searchBar').value.toLowerCase();if(!q){data.subs=data._origSubs;data.customers=data._origCustomers;data.orders=data._origOrders}else{data.subs=(data._origSubs||[]).filter(s=>s.customerEmail?.toLowerCase().includes(q)||s.customerName?.toLowerCase().includes(q));data.customers=(data._origCustomers||[]).filter(c=>c.email?.toLowerCase().includes(q)||c.name?.toLowerCase().includes(q));data.orders=(data._origOrders||[]).filter(o=>o.customerEmail?.toLowerCase().includes(q)||o.customerName?.toLowerCase().includes(q))}renderTab()},200)}
function fmt(cents){return((cents||0)/100).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}
function fmtDate(d){if(!d)return'—';return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function timeAgo(t){if(!t)return'';const diff=(Date.now()-new Date(t).getTime())/1000;if(diff<60)return'just now';if(diff<3600)return Math.floor(diff/60)+'m ago';if(diff<86400)return Math.floor(diff/3600)+'h ago';return Math.floor(diff/86400)+'d ago'}
document.getElementById('tabs').addEventListener('click',e=>{if(e.target.dataset.tab){currentTab=e.target.dataset.tab;renderTab()}});
if(token)showDash().catch(()=>doLogout());
</script>
</body>
</html>
